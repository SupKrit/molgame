<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mol Impact V.47: Survivor Guide</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&family=Kanit:wght@400;800&display=swap');
        
        :root {
            --bg: #20232a; --panel: #2c3e50; --text: #ecf0f1;
            --gold: #f1c40f; --green: #2ecc71; --red: #c0392b; --blue: #3498db; --dendro: #badc58;
            --purple: #9b59b6;
        }

        body { font-family: 'Sarabun', sans-serif; background: var(--bg); color: var(--text); margin: 0; position: fixed; inset:0; overflow: hidden; display: flex; justify-content: center; user-select: none; }
        #app { width: 100%; max-width: 480px; height: 100%; display: flex; flex-direction: column; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.8); background: #2c3e50; }

        /* SCREENS */
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; background: var(--bg); z-index: 10; overflow-y: auto; }
        
        /* START SCREEN */
        .header { text-align: center; padding: 20px; background: rgba(0,0,0,0.2); }
        .score-inp-box { text-align: center; margin: 10px 20px; padding: 15px; background: #34495e; border-radius: 12px; border: 1px solid #7f8c8d; }
        .score-inp { background: #2c3e50; border: 2px solid var(--gold); color: white; padding: 10px; font-size: 1.2em; width: 80px; text-align: center; border-radius: 8px; font-family: 'Kanit'; outline: none; }
        
        .btn-guide { background: transparent; border: 1px solid var(--blue); color: var(--blue); padding: 5px 15px; border-radius: 20px; font-size: 0.9em; cursor: pointer; margin-top: 10px; font-family: 'Kanit'; transition: 0.2s; }
        .btn-guide:active { background: var(--blue); color: white; }

        .class-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 10px 15px; }
        .class-card { background: rgba(255,255,255,0.08); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 10px 5px; text-align: center; transition: 0.2s; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80px; }
        .class-card:active { transform: scale(0.95); border-color: var(--gold); background: rgba(255,255,255,0.2); }
        .c-icon { font-size: 24px; margin-bottom: 5px; }
        .c-name { font-weight: bold; font-family: 'Kanit'; font-size: 0.9em; }
        .c-desc { font-size: 0.7em; color: #bdc3c7; }

        /* GUIDE SCREEN (New) */
        #scr-guide { background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 200; padding: 20px; }
        .guide-box { background: #2c3e50; border: 1px solid var(--gold); border-radius: 15px; overflow: hidden; display: flex; flex-direction: column; max-height: 90vh; }
        .g-head { background: var(--gold); color: #000; padding: 15px; text-align: center; font-family: 'Kanit'; font-size: 1.5em; font-weight: bold; }
        .g-body { padding: 20px; overflow-y: auto; font-size: 0.95em; line-height: 1.6; }
        .g-section { margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .g-section h3 { color: var(--blue); font-family: 'Kanit'; margin: 0 0 5px 0; display:flex; align-items:center; gap:5px; }
        .tag-rule { display: inline-block; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin: 2px; }
        .curse-h { color: #e74c3c; font-weight: bold; }

        /* HUD */
        .hud { padding: 10px 15px; background: rgba(0,0,0,0.3); display: flex; gap: 10px; align-items: center; height: 110px; flex-shrink: 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .avatar { width: 65px; height: 65px; background: rgba(255,255,255,0.1); border: 2px solid var(--gold); border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 30px; position: relative; }
        .lv-badge { position: absolute; bottom: -5px; right: -5px; background: var(--gold); color: #000; font-size: 0.7em; font-weight: bold; padding: 2px 6px; border-radius: 8px; font-family: 'Kanit'; }
        
        .stat-box { flex: 1; display: flex; flex-direction: column; gap: 5px; }
        .bar-wrap { height: 14px; background: rgba(0,0,0,0.5); border-radius: 8px; overflow: hidden; position: relative; }
        .fill { height: 100%; transition: width 0.3s; }
        .bar-txt { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: bold; text-shadow: 1px 1px 2px #000; z-index: 2; font-family: 'Kanit'; pointer-events: none; }
        
        .time-row { display: flex; align-items: center; gap: 5px; margin-top: 2px; }
        .time-track { flex: 1; height: 6px; background: #555; border-radius: 3px; overflow: hidden; }
        .time-fill { height: 100%; background: var(--gold); width: 100%; transition: width 1s linear; }
        .time-val { font-size: 0.8em; color: var(--gold); width: 35px; text-align: right; }

        /* GAMEPLAY */
        .stage { flex: 1; display: flex; justify-content: space-between; align-items: flex-end; padding: 20px 40px; background: linear-gradient(to bottom, #2c3e50, #20232a); position: relative; }
        .sprite { font-size: 80px; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)); transition: transform 0.2s; }

        .panel { background: #34495e; padding: 20px; border-radius: 25px 25px 0 0; display: flex; flex-direction: column; gap: 12px; z-index: 20; box-shadow: 0 -10px 30px rgba(0,0,0,0.5); }
        .skills { display: flex; gap: 8px; }
        .sk-btn { flex: 1; background: rgba(255,255,255,0.1); border-radius: 8px; padding: 6px 0; text-align: center; font-size: 0.75em; cursor: pointer; color: #dfe6e9; display: flex; flex-direction: column; align-items: center; transition: background 0.1s; }
        .sk-btn:active { background: rgba(255,255,255,0.2); transform: scale(0.95); }
        
        .q-box { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; min-height: 100px; text-align: center; border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; justify-content: center; position: relative; transition: 0.3s; }
        /* BONUS STYLE */
        .q-box.bonus-mode { border: 2px solid var(--gold); background: rgba(241, 196, 15, 0.15); box-shadow: 0 0 15px rgba(241, 196, 15, 0.3); }
        .bonus-badge { position: absolute; top: -12px; right: -10px; background: var(--gold); color: #000; font-weight: 800; font-family: 'Kanit'; padding: 2px 10px; border-radius: 20px; font-size: 0.8em; transform: rotate(10deg); box-shadow: 0 2px 5px rgba(0,0,0,0.3); animation: pulse 1s infinite; display: none; }
        .q-box.bonus-mode .bonus-badge { display: block; }

        .topic-tag { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: var(--gold); color: #000; font-size: 0.7em; padding: 2px 8px; border-radius: 10px; font-weight: bold; text-transform: uppercase; }
        .format-hint { font-size: 0.8em; color: #f39c12; margin-top: 5px; font-weight: bold; }

        .inp-group { display: flex; gap: 10px; height: 55px; }
        .inp { flex: 1; background: #2c3e50; border: 2px solid #7f8c8d; color: #fff; text-align: center; font-size: 1.5em; border-radius: 12px; font-family: 'Kanit'; outline: none; }
        .btn-atk { background: var(--green); color: #fff; border: none; padding: 0 20px; border-radius: 12px; font-weight: bold; font-size: 1.2em; font-family: 'Kanit'; cursor: pointer; transition: 0.1s; }
        .btn-atk:active { transform: scale(0.95); background: #27ae60; }

        /* TUTOR & OVERLAYS */
        #scr-tutor, #scr-reward, #scr-win { background: rgba(0,0,0,0.95); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; padding: 20px; z-index: 100; }
        
        .t-card { background: #ecf0f1; color: #2c3e50; border-radius: 20px; padding: 0; width: 100%; max-width: 420px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); max-height: 85vh; display: flex; flex-direction: column; overflow: hidden; }
        .t-header { padding: 20px; text-align: center; background: #dfe6e9; border-bottom: 1px solid #bdc3c7; flex-shrink: 0; }
        .t-body { padding: 20px; overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
        .t-footer { padding: 15px 20px; background: #dfe6e9; border-top: 1px solid #bdc3c7; flex-shrink: 0; }

        .tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid #bdc3c7; }
        .tab-btn { flex: 1; padding: 10px; background: transparent; border: none; border-bottom: 4px solid transparent; cursor: pointer; font-family: 'Kanit'; font-weight: bold; color: #7f8c8d; transition:0.2s; }
        .tab-btn.active { border-bottom-color: #3498db; color: #3498db; background: rgba(52, 152, 219, 0.1); }
        
        .sol-panel { display: none; text-align: left; }
        .sol-panel.active { display: block; animation: fadeIn 0.3s; }

        .step-box { background: #fff; border-left: 4px solid #3498db; padding: 10px 15px; margin-bottom: 15px; border-radius: 0 8px 8px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .step-title { font-weight: 800; color: #2980b9; font-size: 0.9em; margin-bottom: 5px; text-transform: uppercase; font-family: 'Kanit'; }
        .step-content { font-size: 1em; color: #2c3e50; line-height: 1.6; }
        .math-highlight { background: #e8f6f3; padding: 2px 6px; border-radius: 4px; color: #16a085; font-weight: bold; font-family: 'Courier New', monospace; }
        .cut-unit { text-decoration: line-through; color: #e74c3c; opacity: 0.6; }

        .btn-claim, .btn-restart { width: 100%; padding: 12px; background: var(--gold); color: #000; border: none; border-radius: 12px; font-size: 1.3em; font-family: 'Kanit'; font-weight:bold; cursor: pointer; }
        .curse-warning { font-size:0.8em; color:#e74c3c; text-align:center; margin-top:5px; background:rgba(231, 76, 60, 0.1); padding:5px; border-radius:5px; }

        .reward-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px; }
        .r-card { background: #34495e; color: #fff; padding: 15px; border-radius: 12px; border: 2px solid #7f8c8d; cursor: pointer; display: flex; align-items: center; gap: 15px; position:relative; overflow: hidden; }
        .r-card:active { border-color: var(--gold); transform: translateY(2px); }
        .r-icon { font-size: 24px; }

        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div id="app">
    <div id="scr-class" class="screen" style="display:flex;">
        <div class="header">
            <h1 style="font-family:'Kanit'; margin:0; font-size:1.8em;">MOL IMPACT <span style="color:var(--gold)">V.47</span></h1>
            <p style="color:#bdc3c7; margin-bottom:5px;">Survivor Guide Edition</p>
            <button class="btn-guide" onclick="toggleGuide(true)">üìñ ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</button>
        </div>
        <div class="score-inp-box">
            <label style="display:block; margin-bottom:10px; color:var(--gold);">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ (0-20)</label>
            <input type="number" id="mid-score" class="score-inp" placeholder="0" min="0" max="20">
        </div>
        <div class="class-grid">
            <div class="class-card" style="border-color:#e74c3c" onclick="startGame('Pyro')">
                <span class="c-icon">üî•</span><div class="c-name">Pyro</div><div class="c-desc">HP ‡∏™‡∏π‡∏á</div>
            </div>
            <div class="class-card" style="border-color:#3498db" onclick="startGame('Hydro')">
                <span class="c-icon">üíß</span><div class="c-name">Hydro</div><div class="c-desc">MP ‡πÄ‡∏¢‡∏≠‡∏∞</div>
            </div>
            <div class="class-card" style="border-color:#1abc9c" onclick="startGame('Anemo')">
                <span class="c-icon">üå™Ô∏è</span><div class="c-name">Anemo</div><div class="c-desc">‡πÄ‡∏ß‡∏•‡∏≤ +20s</div>
            </div>
            <div class="class-card" style="border-color:#badc58" onclick="startGame('Dendro')">
                <span class="c-icon">üåø</span><div class="c-name">Dendro</div><div class="c-desc">‡∏ï‡πâ‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏™‡∏≤‡∏õ</div>
            </div>
            <div class="class-card" style="border-color:#9b59b6; grid-column: span 2;" onclick="startGame('Electro')">
                <span class="c-icon">‚ö°</span><div class="c-name">Electro</div><div class="c-desc">‡∏™‡∏°‡∏î‡∏∏‡∏• (HP/MP)</div>
            </div>
        </div>
    </div>

    <div id="scr-guide" class="screen">
        <div class="guide-box">
            <div class="g-head">SURVIVOR GUIDE</div>
            <div class="g-body">
                <div class="g-section">
                    <h3>üèÜ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Goal)</h3>
                    <p>‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ó‡∏≥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á <b>14 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ú‡πà‡∏≤‡∏ô‡∏î‡πà‡∏≤‡∏ô!</p>
                    <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:8px; text-align:center; margin-top:5px;">
                        <span style="color:var(--gold)">Level (Lv)</span> + 
                        <span style="color:#3498db">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ</span> ‚â• 14
                    </div>
                </div>

                <div class="g-section">
                    <h3>‚öîÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô (Gameplay)</h3>
                    <p>‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Ñ‡∏°‡∏µ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á "‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏™‡∏≤‡∏£‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå" ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡∏®‡∏±‡∏ï‡∏£‡∏π</p>
                    <div>
                        <span class="tag-rule">‚úÖ ‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å</span> ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö EXP + ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•<br>
                        <span class="tag-rule">‚ùå ‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î</span> ‡πÄ‡∏™‡∏µ‡∏¢ HP (‡∏ñ‡πâ‡∏≤‡∏´‡∏°‡∏î = Game Over)
                    </div>
                </div>

                <div class="g-section">
                    <h3>üéÅ ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• & ‡∏Ñ‡∏≥‡∏™‡∏≤‡∏õ (Risk)</h3>
                    <p>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ä‡∏ô‡∏∞ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ ‡πÅ‡∏ï‡πà‡∏£‡∏∞‡∏ß‡∏±‡∏á!</p>
                    <p class="curse-h">‚ö†Ô∏è ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ 20% ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÇ‡∏î‡∏ô‡∏Ñ‡∏≥‡∏™‡∏≤‡∏õ (‡πÄ‡∏™‡∏µ‡∏¢ HP ‡πÅ‡∏ó‡∏ô)</p>
                    <small style="color:#bdc3c7">*Dendro üåø ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏≤‡∏õ‡πÑ‡∏î‡πâ 100%</small>
                </div>
                
                <div class="g-section">
                    <h3>üåü Bonus Stage</h3>
                    <p>‡∏ö‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏à‡∏∞‡πÄ‡∏à‡∏≠‡∏î‡πà‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏µ‡∏ó‡∏≠‡∏á) ‡πÇ‡∏à‡∏ó‡∏¢‡πå 2 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô</p>
                    <span class="tag-rule" style="background:var(--gold); color:#000; font-weight:bold;">EXP x2</span> 
                    <span class="tag-rule" style="background:var(--gold); color:#000; font-weight:bold;">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Ñ‡∏π‡∏ì‡∏™‡∏≠‡∏á</span>
                </div>

                <button class="btn-claim" onclick="toggleGuide(false)">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß! (Close)</button>
            </div>
        </div>
    </div>

    <div id="scr-game" class="screen">
        <div class="hud">
            <div class="avatar" id="u-icon">üî•</div>
            <div class="stat-box">
                <div class="bar-wrap"><div class="bar-txt" id="hp-txt">HP</div><div id="hp-bar" class="fill" style="background:var(--red); width:100%"></div></div>
                <div class="bar-wrap"><div class="bar-txt" id="mp-txt">MP</div><div id="mp-bar" class="fill" style="background:var(--blue); width:100%"></div></div>
                <div class="bar-wrap"><div class="bar-txt" id="xp-txt">EXP</div><div id="xp-bar" class="fill" style="background:var(--green); width:0%"></div></div>
                
                <div class="time-row">
                    <div class="time-track"><div id="t-bar" class="time-fill"></div></div>
                    <div id="t-txt" class="time-val">60s</div>
                </div>
            </div>
        </div>
        
        <div class="stage">
            <div class="sprite" id="u-sprite" style="transform: scaleX(-1);">üî•</div>
            <div class="sprite">üëª</div>
        </div>

        <div class="panel">
            <div class="skills" id="skill-box"></div>
            <div id="q-box" class="q-box">
                <div class="bonus-badge">‚òÖ BONUS x2 ‚òÖ</div>
                </div>
            <div class="inp-group">
                <input type="number" id="ans-in" class="inp" placeholder="‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö..." inputmode="decimal" step="any">
                <button class="btn-atk" onclick="checkAns()">Attack</button>
            </div>
        </div>
    </div>

    <div id="scr-tutor">
        <div class="t-card">
            <div class="t-header">
                <h2 id="res-title" style="margin:0; font-family:'Kanit';">Result</h2>
                <div id="feed-box" style="background:#fab1a0; color:#c0392b; padding:8px; border-radius:6px; margin-top:10px; font-size:0.9em; display:none;"></div>
            </div>
            
            <div class="t-body">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('factor')" id="btn-factor">‚öóÔ∏è ‡∏ï‡∏±‡∏î‡∏´‡∏ô‡πà‡∏ß‡∏¢ (Factor)</button>
                    <button class="tab-btn" onclick="switchTab('formula')" id="btn-formula">üìê ‡πÉ‡∏ä‡πâ‡∏™‡∏π‡∏ï‡∏£ (Formula)</button>
                </div>
                <div id="sol-factor" class="sol-panel active"></div>
                <div id="sol-formula" class="sol-panel"></div>
            </div>

            <div class="t-footer">
                <button id="btn-action" class="btn-claim" onclick="goToReward()">üéÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</button>
            </div>
        </div>
    </div>

    <div id="scr-reward" style="display:none;">
        <div class="t-card" style="background:#2c3e50; border:1px solid var(--gold); padding:20px;">
            <h2 style="color:var(--gold); font-family:'Kanit'; margin:0; text-align:center;">LEVEL UP!</h2>
            <div class="curse-warning">‚ö†Ô∏è ‡∏£‡∏∞‡∏ß‡∏±‡∏á! ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á 20% ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏à‡∏∞‡∏•‡∏î</div>
            <div class="reward-grid">
                <div class="r-card" onclick="claimReward('xp')"><div class="r-icon">üìö</div><div><h4>EXP Boost</h4></div></div>
                <div class="r-card" onclick="claimReward('mp')"><div class="r-icon">üíß</div><div><h4>Mana Refill</h4></div></div>
                <div class="r-card" onclick="claimReward('cost')"><div class="r-icon">üìâ</div><div><h4>Skill Mastery</h4></div></div>
            </div>
        </div>
    </div>

    <div id="scr-win">
        <div class="t-card" style="text-align:center; background: linear-gradient(135deg, #f1c40f, #f39c12); color:#000; padding:30px;">
            <div style="font-size:60px;">üèÜ</div>
            <h1 style="margin:0;">MISSION COMPLETE</h1>
            <p>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: <span id="win-total" style="font-weight:bold; font-size:1.5em;">0</span> / 14</p>
            <button class="btn-restart" onclick="resetGame()">üîÑ ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        </div>
    </div>
</div>

<script>
    // --- AUDIO SYSTEM ---
    const sfx = {
        ctx: null,
        init: function() {
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            this.ctx = new AudioContext();
        },
        play: function(type) {
            if (!this.ctx) this.init();
            const now = this.ctx.currentTime;
            const o = this.ctx.createOscillator();
            const g = this.ctx.createGain();
            o.connect(g); g.connect(this.ctx.destination);

            if (type === 'atk') {
                o.type = 'square'; o.frequency.setValueAtTime(400, now);
                o.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                g.gain.setValueAtTime(0.1, now); g.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                o.start(now); o.stop(now + 0.1);
            } else if (type === 'correct') {
                o.type = 'sine'; o.frequency.setValueAtTime(600, now);
                g.gain.setValueAtTime(0.1, now); g.gain.linearRampToValueAtTime(0, now + 0.1);
                o.start(now); o.stop(now + 0.1);
                setTimeout(()=>{
                    const o2=this.ctx.createOscillator(); const g2=this.ctx.createGain();
                    o2.connect(g2); g2.connect(this.ctx.destination);
                    o2.frequency.setValueAtTime(900, this.ctx.currentTime);
                    g2.gain.setValueAtTime(0.1, this.ctx.currentTime); g2.gain.linearRampToValueAtTime(0, this.ctx.currentTime+0.2);
                    o2.start(this.ctx.currentTime); o2.stop(this.ctx.currentTime+0.2);
                },100);
            } else if (type === 'bonus') {
                o.type = 'triangle'; 
                [523, 659, 784, 1046].forEach((f, i) => {
                    setTimeout(() => {
                        const osc = this.ctx.createOscillator(); const gn = this.ctx.createGain();
                        osc.connect(gn); gn.connect(this.ctx.destination);
                        osc.frequency.value = f; osc.type='sine';
                        gn.gain.setValueAtTime(0.1, this.ctx.currentTime); gn.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime+0.3);
                        osc.start(this.ctx.currentTime); osc.stop(this.ctx.currentTime+0.3);
                    }, i*100);
                });
            } else if (type === 'wrong') {
                o.type = 'sawtooth'; o.frequency.setValueAtTime(150, now);
                o.frequency.linearRampToValueAtTime(100, now + 0.3);
                g.gain.setValueAtTime(0.1, now); g.gain.linearRampToValueAtTime(0, now + 0.3);
                o.start(now); o.stop(now + 0.3);
            } else if (type === 'skill') {
                o.type = 'triangle'; o.frequency.setValueAtTime(300, now);
                o.frequency.linearRampToValueAtTime(800, now + 0.5);
                g.gain.setValueAtTime(0.05, now); g.gain.linearRampToValueAtTime(0, now + 0.5);
                o.start(now); o.stop(now + 0.5);
            } else if (type === 'level') {
                [440, 554, 659, 880].forEach((f, i) => {
                    setTimeout(() => {
                        const os = this.ctx.createOscillator(); const gn = this.ctx.createGain();
                        os.connect(gn); gn.connect(this.ctx.destination);
                        os.type = 'square'; os.frequency.value = f;
                        gn.gain.value = 0.05; gn.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime+0.2);
                        os.start(this.ctx.currentTime); os.stop(this.ctx.currentTime+0.2);
                    }, i*100);
                });
            }
        }
    };

    // --- DATABASE ---
    const AM = { H:1, C:12, N:14, O:16, Na:23, S:32, Cl:35.5, K:39, Ca:40, Mn:55 };

    const DB = [
        { f:"H‚ÇÇO", name:"‡∏ô‡πâ‡∏≥", mw:18, d:1.00, atoms:{H:2, O:1}, type:'cov' },
        { f:"CO‚ÇÇ", name:"‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏≠‡∏ô‡πÑ‡∏î‡∏≠‡∏≠‡∏Å‡πÑ‡∏ã‡∏î‡πå", mw:44, d:null, atoms:{C:1, O:2}, type:'cov' },
        { f:"NH‚ÇÉ", name:"‡πÅ‡∏≠‡∏°‡πÇ‡∏°‡πÄ‡∏ô‡∏µ‡∏¢", mw:17, d:0.73, atoms:{N:1, H:3}, type:'cov' },
        { f:"CH‚ÇÑ", name:"‡∏°‡∏µ‡πÄ‡∏ó‡∏ô", mw:16, d:null, atoms:{C:1, H:4}, type:'cov' },
        { f:"NaCl", name:"‡πÄ‡∏Å‡∏•‡∏∑‡∏≠‡πÅ‡∏Å‡∏á", mw:58.5, d:2.16, atoms:{Na:1, Cl:1}, type:'ion' },
        { f:"H‚ÇÇSO‚ÇÑ", name:"‡∏Å‡∏£‡∏î‡∏ã‡∏±‡∏•‡∏ü‡∏¥‡∏ß‡∏£‡∏¥‡∏Å", mw:98, d:1.83, atoms:{H:2, S:1, O:4}, type:'cov' },
        { f:"HCl", name:"‡∏Å‡∏£‡∏î‡πÄ‡∏Å‡∏•‡∏∑‡∏≠", mw:36.5, d:1.18, atoms:{H:1, Cl:1}, type:'cov' },
        { f:"NaOH", name:"‡πÇ‡∏ã‡∏î‡∏≤‡πÑ‡∏ü", mw:40, d:2.13, atoms:{Na:1, O:1, H:1}, type:'ion' },
        { f:"HNO‚ÇÉ", name:"‡∏Å‡∏£‡∏î‡πÑ‡∏ô‡∏ó‡∏£‡∏¥‡∏Å", mw:63, d:1.51, atoms:{H:1, N:1, O:3}, type:'cov' },
        { f:"CaCO‚ÇÉ", name:"‡∏´‡∏¥‡∏ô‡∏õ‡∏π‡∏ô", mw:100, d:2.71, atoms:{Ca:1, C:1, O:3}, type:'ion' },
        { f:"KMnO‚ÇÑ", name:"‡∏î‡πà‡∏≤‡∏á‡∏ó‡∏±‡∏ö‡∏ó‡∏¥‡∏°", mw:158, d:2.70, atoms:{K:1, Mn:1, O:4}, type:'ion' },
        { f:"C‚ÇÜH‚ÇÅ‚ÇÇO‚ÇÜ", name:"‡∏Å‡∏•‡∏π‡πÇ‡∏Ñ‡∏™", mw:180, d:1.54, atoms:{C:6, H:12, O:6}, type:'cov' },
        { f:"O‚ÇÇ", name:"‡πÅ‡∏Å‡πä‡∏™‡∏≠‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏à‡∏ô", mw:32, d:null, atoms:{O:2}, type:'cov' }
    ];

    let g = { 
        hp:100, maxH:100, mp:50, maxM:50, xp:0, lv:1, cls:'',
        ans:0, qData:null, timer:null, tMax:60, tLeft:60,
        midScore: 0, skillCostMod: 1.0, isCorrect: false,
        weaknessQueue: [], isBonus: false
    };

    // --- GAME CONTROL ---
    function toggleGuide(show) {
        sfx.play('skill');
        document.getElementById('scr-guide').style.display = show ? 'flex' : 'none';
    }

    function startGame(cls) {
        sfx.init(); sfx.play('skill');
        let sc = document.getElementById('mid-score').value;
        if(sc === '' || sc < 0 || sc > 20) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (0-20)");
        g.midScore = parseInt(sc); g.cls = cls;

        if(cls==='Pyro'){ g.maxH=150; g.maxM=50; g.icon='üî•'; g.tMax=60; }
        else if(cls==='Hydro'){ g.maxH=100; g.maxM=120; g.icon='üíß'; g.tMax=60; }
        else if(cls==='Anemo'){ g.maxH=100; g.maxM=80; g.icon='üå™Ô∏è'; g.tMax=80; }
        else if(cls==='Dendro'){ g.maxH=120; g.maxM=80; g.icon='üåø'; g.tMax=60; }
        else if(cls==='Electro'){ g.maxH=110; g.maxM=90; g.icon='‚ö°'; g.tMax=60; }
        
        g.hp=g.maxH; g.mp=g.maxM; g.tLeft=g.tMax; g.xp=0; g.lv=1; g.weaknessQueue=[];
        document.getElementById('u-icon').innerHTML = g.icon + `<div class="lv-badge">Lv.${g.lv}</div>`;
        document.getElementById('u-sprite').innerText = g.icon;
        document.getElementById('scr-class').style.display='none';
        document.getElementById('scr-game').style.display='flex';
        renderSkills(); updateUI(); genQuest();
    }

    function resetGame() {
        clearInterval(g.timer);
        document.getElementById('scr-win').style.display = 'none';
        document.getElementById('scr-game').style.display = 'none';
        document.getElementById('scr-tutor').style.display = 'none';
        document.getElementById('scr-reward').style.display = 'none';
        document.getElementById('scr-guide').style.display = 'none';
        document.getElementById('scr-class').style.display = 'flex';
        document.getElementById('ans-in').value = '';
        document.getElementById('q-box').classList.remove('bonus-mode');
    }

    function renderSkills() {
        const skills = [
            { id:'heal', name:'Heal', icon:'üíñ', base:20 },
            { id:'time', name:'Time', icon:'‚è≥', base:15 },
            { id:'hint', name:'Hint', icon:'üí°', base:10 },
            { id:'skip', name:'Skip', icon:'‚è©', base:30 }
        ];
        let html = '';
        skills.forEach(s => {
            html += `<div class="sk-btn" onclick="useSkill('${s.id}', ${s.base})">
                        <div style="font-size:1.4em">${s.icon}</div>${s.name} <span style="font-size:0.7em; color:#3498db">${s.base} MP</span>
                     </div>`;
        });
        document.getElementById('skill-box').innerHTML = html;
    }

    // --- LOGIC: NORMAL & BONUS ---
    function genQuest() {
        clearInterval(g.timer);
        g.tLeft = g.tMax;
        startTimer();
        document.getElementById('ans-in').value = '';
        document.getElementById('q-box').classList.remove('bonus-mode');
        g.isBonus = false;

        // CHECK BONUS CHANCE (15%)
        if (Math.random() < 0.15) {
            g.isBonus = true;
            document.getElementById('q-box').classList.add('bonus-mode');
            sfx.play('bonus');
            genBonusQuest();
            return;
        }
        
        const chem = DB[Math.floor(Math.random() * DB.length)];
        const pName = chem.type === 'ion' ? '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏™‡∏π‡∏ï‡∏£' : '‡πÇ‡∏°‡πÄ‡∏•‡∏Å‡∏∏‡∏•'; 
        
        let mode = g.weaknessQueue.length > 0 ? g.weaknessQueue[0] : Math.floor(Math.random() * 7);
        if (mode === 2 && !chem.d) mode = 0;
        
        let val = (Math.random() * 5 + 1).toFixed(1); 
        if (val % 1 === 0) val = Math.floor(val); 

        let qObj = { topic:"", q:"", rawAns:0, hint:"" };
        let factSteps = [], formSteps = [];

        // 0: Mass <-> Mol
        if (mode === 0) {
            let subMode = Math.random() > 0.5;
            qObj.topic = "Mass ‚Üî Mole";
            qObj.hint = "(‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°)";
            if(subMode) { // g -> mol
                qObj.rawAns = val / chem.mw;
                qObj.q = `‡∏™‡∏≤‡∏£ <b>${chem.f}</b> ‡∏°‡∏ß‡∏• <b>${val} g</b> ‡∏°‡∏µ‡∏Å‡∏µ‡πà‡πÇ‡∏°‡∏•? <br>(MW = ${chem.mw} g/mol)`;
                
                formSteps.push({t:"‡∏™‡∏π‡∏ï‡∏£", c:`<span class="math-highlight">n = m / MW</span>`});
                formSteps.push({t:"‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤", c:`n = ${val} / ${chem.mw} = ${qObj.rawAns.toFixed(2)} mol`});

                factSteps.push({t:"‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Å‡∏≥‡∏´‡∏ô‡∏î", c:`‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å <b>${val} g</b>`});
                factSteps.push({t:"Conversion Factor", c:`1 mol ‡∏´‡∏ô‡∏±‡∏Å ${chem.mw} g`});
                factSteps.push({t:"‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏´‡∏ô‡πà‡∏ß‡∏¢", c:`${val} <span class="cut-unit">g</span> √ó [ 1 mol / ${chem.mw} <span class="cut-unit">g</span> ]`});
            } else { // mol -> g
                qObj.rawAns = val * chem.mw;
                qObj.q = `‡∏™‡∏≤‡∏£ <b>${chem.f}</b> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <b>${val} mol</b> ‡∏°‡∏µ‡∏°‡∏ß‡∏•‡∏Å‡∏µ‡πà‡∏Å‡∏£‡∏±‡∏°? <br>(MW = ${chem.mw} g/mol)`;
                
                formSteps.push({t:"‡∏™‡∏π‡∏ï‡∏£", c:`m = n √ó MW`});
                formSteps.push({t:"‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤", c:`m = ${val} √ó ${chem.mw} = ${qObj.rawAns.toFixed(2)} g`});

                factSteps.push({t:"‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Å‡∏≥‡∏´‡∏ô‡∏î", c:`‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å <b>${val} mol</b>`});
                factSteps.push({t:"Conversion Factor", c:`1 mol ‡∏´‡∏ô‡∏±‡∏Å ${chem.mw} g`});
                factSteps.push({t:"‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏´‡∏ô‡πà‡∏ß‡∏¢", c:`${val} <span class="cut-unit">mol</span> √ó [ ${chem.mw} g / 1 <span class="cut-unit">mol</span> ]`});
            }
        }
        // 1: Vol <-> Mol
        else if (mode === 1) {
            let subMode = Math.random() > 0.5;
            qObj.topic = "Mole ‚Üî Volume (STP)";
            qObj.hint = "(‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°)";
            if(subMode) { // mol -> L
                qObj.rawAns = val * 22.4;
                qObj.q = `‡πÅ‡∏Å‡πä‡∏™ <b>${chem.f}</b> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <b>${val} mol</b> ‡∏°‡∏µ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏µ‡πà‡∏•‡∏¥‡∏ï‡∏£‡∏ó‡∏µ‡πà STP?`;
                
                formSteps.push({t:"‡∏™‡∏π‡∏ï‡∏£", c:`V = n √ó 22.4`});
                formSteps.push({t:"‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤", c:`V = ${val} √ó 22.4 = ${qObj.rawAns.toFixed(2)} L`});

                factSteps.push({t:"Factor", c:`1 mol = 22.4 L`});
                factSteps.push({t:"‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏°‡∏Å‡∏≤‡∏£", c:`${val} <span class="cut-unit">mol</span> √ó [ 22.4 L / 1 <span class="cut-unit">mol</span> ]`});
            } else { // L -> mol
                qObj.rawAns = val / 22.4;
                qObj.q = `‡πÅ‡∏Å‡πä‡∏™ <b>${chem.f}</b> ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ <b>${val} L</b> (STP) ‡∏°‡∏µ‡∏Å‡∏µ‡πà‡πÇ‡∏°‡∏•?`;
                
                formSteps.push({t:"‡∏™‡∏π‡∏ï‡∏£", c:`n = V / 22.4`});
                formSteps.push({t:"‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤", c:`n = ${val} / 22.4 = ${qObj.rawAns.toFixed(2)} mol`});

                factSteps.push({t:"Factor", c:`1 mol = 22.4 L`});
                factSteps.push({t:"‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì", c:`${val} <span class="cut-unit">L</span> √ó [ 1 mol / 22.4 <span class="cut-unit">L</span> ]`});
            }
        }
        // 2: Density
        else if (mode === 2) {
             qObj.topic = "Density (d = m/V)";
             qObj.hint = "(‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°)";
             let subMode = Math.random() > 0.5;
             if(subMode) { // V -> m
                qObj.rawAns = chem.d * val;
                qObj.q = `‡∏™‡∏≤‡∏£ <b>${chem.f}</b> ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ <b>${val} cm¬≥</b> ‡∏°‡∏µ‡∏°‡∏ß‡∏•‡∏Å‡∏µ‡πà‡∏Å‡∏£‡∏±‡∏°? <br>(d = ${chem.d} g/cm¬≥)<br>`;
                formSteps.push({t:"‡∏™‡∏π‡∏ï‡∏£", c:`m = d √ó V`});
                formSteps.push({t:"‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤", c:`m = ${chem.d} √ó ${val} = ${qObj.rawAns.toFixed(2)} g`});
                factSteps.push({t:"Factor", c:`‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏Ñ‡∏∑‡∏≠ <b>${chem.d} g / 1 cm¬≥</b>`});
                factSteps.push({t:"‡∏ï‡∏±‡∏î‡∏´‡∏ô‡πà‡∏ß‡∏¢", c:`${val} <span class="cut-unit">cm¬≥</span> √ó [ ${chem.d} g / 1 <span class="cut-unit">cm¬≥</span> ]`});
             } else { // m -> V
                qObj.rawAns = val / chem.d;
                qObj.q = `‡∏™‡∏≤‡∏£ <b>${chem.f}</b> ‡∏°‡∏ß‡∏• <b>${val} g</b> ‡∏°‡∏µ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏µ‡πà cm¬≥? <br>(d = ${chem.d} g/cm¬≥)<br>`;
                formSteps.push({t:"‡∏™‡∏π‡∏ï‡∏£", c:`V = m / d`});
                formSteps.push({t:"‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤", c:`V = ${val} / ${chem.d} = ${qObj.rawAns.toFixed(2)} cm¬≥`});
                factSteps.push({t:"Factor", c:`d = ${chem.d} g/cm¬≥ ‚ûú ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô (1 cm¬≥ / ${chem.d} g)`});
                factSteps.push({t:"‡∏ï‡∏±‡∏î‡∏´‡∏ô‡πà‡∏ß‡∏¢", c:`${val} <span class="cut-unit">g</span> √ó [ 1 cm¬≥ / ${chem.d} <span class="cut-unit">g</span> ]`});
             }
        }
        // 3: Particle <-> Mol
        else if (mode === 3) {
            qObj.topic = "Particle ‚Üî Mole";
            let subMode = Math.random() > 0.5;
            if(subMode) {
                 qObj.rawAns = val * 6.02;
                 qObj.q = `‡∏™‡∏≤‡∏£ <b>${chem.f}</b> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <b>${val} mol</b> ‡∏°‡∏µ‡∏Å‡∏µ‡πà${pName}?`;
                 qObj.hint = "(‡∏ï‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ √ó 10¬≤¬≥)";
                 
                 formSteps.push({t:"‡∏™‡∏π‡∏ï‡∏£", c:`<span class="math-highlight">N = n √ó 6.02√ó10¬≤¬≥</span>`});
                 formSteps.push({t:"‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤", c:`N = ${val} √ó 6.02... = ${qObj.rawAns.toFixed(2)} √ó 10¬≤¬≥`});

                 factSteps.push({t:"Factor", c:`1 mol = 6.02√ó10¬≤¬≥ ‡∏≠‡∏ô‡∏∏‡∏†‡∏≤‡∏Ñ`});
                 factSteps.push({t:"‡∏ï‡∏±‡∏î‡∏´‡∏ô‡πà‡∏ß‡∏¢", c:`${val} <span class="cut-unit">mol</span> √ó [ 6.02√ó10¬≤¬≥ / 1 <span class="cut-unit">mol</span> ]`});
            } else {
                 let m = Math.floor(Math.random() * 4 + 1) * 0.5;
                 let pVal = (m * 6.02).toFixed(2);
                 qObj.rawAns = m;
                 qObj.q = `‡∏™‡∏≤‡∏£ <b>${chem.f}</b> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <b>${pVal} √ó 10¬≤¬≥</b> ${pName} ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏µ‡πà‡πÇ‡∏°‡∏•?`;
                 qObj.hint = "(‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°)";

                 formSteps.push({t:"‡∏™‡∏π‡∏ï‡∏£", c:`<span class="math-highlight">n = N / 6.02√ó10¬≤¬≥</span>`});
                 formSteps.push({t:"‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤", c:`n = ${pVal} / 6.02`});

                 factSteps.push({t:"Factor", c:`1 mol = 6.02√ó10¬≤¬≥ ‡∏≠‡∏ô‡∏∏‡∏†‡∏≤‡∏Ñ`});
                 factSteps.push({t:"‡∏ï‡∏±‡∏î‡∏´‡∏ô‡πà‡∏ß‡∏¢", c:`${pVal}√ó10¬≤¬≥ <span class="cut-unit">‡∏≠‡∏ô‡∏∏‡∏†‡∏≤‡∏Ñ</span> √ó [ 1 mol / 6.02√ó10¬≤¬≥ <span class="cut-unit">‡∏≠‡∏ô‡∏∏‡∏†‡∏≤‡∏Ñ</span> ]`});
            }
        }
        // 4 & 5: Atom Counting
        else if (mode === 4 || mode === 5) {
            let atoms = Object.keys(chem.atoms);
            let t = atoms[Math.floor(Math.random() * atoms.length)];
            let c = chem.atoms[t];
            qObj.topic = mode === 4 ? "Molecule ‚ûî Atom (Mole)" : "Molecule ‚ûî Atom (Count)";
            qObj.rawAns = val * c;

            if(mode === 4) {
                qObj.q = `‡∏™‡∏≤‡∏£ <b>${chem.f}</b> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <b>${val} mol</b> ‡∏°‡∏µ‡∏≠‡∏∞‡∏ï‡∏≠‡∏° <b>${t}</b> ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡∏µ‡πà mol?`;
                qObj.hint = "(‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°)";
            } else {
                qObj.q = `‡∏™‡∏≤‡∏£ <b>${chem.f}</b> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <b>${val} √ó 10¬≤¬≥ ${pName}</b> ‡∏°‡∏µ‡∏≠‡∏∞‡∏ï‡∏≠‡∏° <b>${t}</b> ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?`;
                qObj.hint = "(‡∏ï‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ √ó 10¬≤¬≥)";
            }
            
            formSteps.push({t:"‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå", c:`1 ${pName} ‡∏Ç‡∏≠‡∏á ${chem.f} ‡∏°‡∏µ <b>${t} ‡∏≠‡∏¢‡∏π‡πà ${c} ‡∏≠‡∏∞‡∏ï‡∏≠‡∏°</b>`});
            formSteps.push({t:"‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì", c:`${val} √ó ${c} = ${qObj.rawAns.toFixed(2)}`});

            factSteps.push({t:"Factor", c:`(${c} atom ${t} / 1 ${pName} ${chem.f})`});
            factSteps.push({t:"‡∏ï‡∏±‡∏î‡∏´‡∏ô‡πà‡∏ß‡∏¢", c:`${val} <span class="cut-unit">${pName}</span> √ó [ ${c} atom ${t} / 1 <span class="cut-unit">${pName}</span> ]`});
        }
        // 6: MW CALCULATION (Focus: Molar Mass)
        else if (mode === 6) {
            qObj.topic = "Molar Mass (g/mol)";
            qObj.hint = "(‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏°‡∏ß‡∏•‡∏≠‡∏∞‡∏ï‡∏≠‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ)";
            qObj.rawAns = chem.mw;
            
            let atomParts = Object.keys(chem.atoms).map(k => `${k}=${AM[k]}`).join(', ');
            qObj.q = `‡∏à‡∏á‡∏´‡∏≤‡∏°‡∏ß‡∏•‡∏ï‡πà‡∏≠‡πÇ‡∏°‡∏• (Molar Mass) ‡∏Ç‡∏≠‡∏á <b>${chem.f}</b> <br>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ: ${atomParts}`;
            
            let calcStr = Object.keys(chem.atoms).map(k => `(${chem.atoms[k]}√ó${AM[k]})`).join(' + ');
            
            formSteps.push({t:"‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£", c:`Molar Mass = ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏°‡∏ß‡∏•‡∏≠‡∏∞‡∏ï‡∏≠‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏™‡∏π‡∏ï‡∏£`});
            formSteps.push({t:"‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏™‡∏π‡∏ï‡∏£", c:`${chem.f} ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢: ` + Object.keys(chem.atoms).map(k => `<br>- ${k}: ${chem.atoms[k]} ‡∏ï‡∏±‡∏ß (‡∏´‡∏ô‡∏±‡∏Å ${AM[k]})`).join('')});
            formSteps.push({t:"‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì", c:`MW = ${calcStr} = <b>${chem.mw}</b>`});

            factSteps.push({t:"Concept", c:`‡∏°‡∏ß‡∏•‡∏ï‡πà‡∏≠‡πÇ‡∏°‡∏•‡∏Ñ‡∏∑‡∏≠‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏£ 1 ‡πÇ‡∏°‡∏• ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏°‡∏ß‡∏•‡πÇ‡∏°‡πÄ‡∏•‡∏Å‡∏∏‡∏•`});
            factSteps.push({t:"‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö", c:`${chem.mw} g/mol`});
        }

        qObj.factSteps = factSteps;
        qObj.formSteps = formSteps;
        qObj.mode = mode;
        finalizeQuest(qObj);
    }

    function genBonusQuest() {
        const chem = DB[Math.floor(Math.random() * DB.length)];
        // Create 2-Step Problems
        let types = ['g_to_L', 'L_to_g', 'g_to_N'];
        let type = types[Math.floor(Math.random() * types.length)];
        let qObj = { topic:"‚òÖ BONUS: 2-Step Calculation", q:"", rawAns:0, hint:"" };
        let factSteps = [], formSteps = [];

        if (type === 'g_to_L' && chem.atoms.O) { // Mass -> Vol (Gas)
            // Use 0.5, 1, 2 moles equivalent
            let n = Math.floor(Math.random()*2) + 0.5; 
            let m = n * chem.mw;
            qObj.rawAns = n * 22.4;
            qObj.q = `‡πÅ‡∏Å‡πä‡∏™ <b>${chem.f}</b> ‡∏°‡∏ß‡∏• <b>${m} g</b> ‡∏°‡∏µ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏µ‡πà‡∏•‡∏¥‡∏ï‡∏£‡∏ó‡∏µ‡πà STP? <br>(MW=${chem.mw})`;
            qObj.hint = "Step 1: g ‚ûú mol, Step 2: mol ‚ûú L";
            
            formSteps.push({t:"Step 1: ‡∏´‡∏≤‡πÇ‡∏°‡∏•", c:`n = m/MW = ${m}/${chem.mw} = ${n} mol`});
            formSteps.push({t:"Step 2: ‡∏´‡∏≤‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£", c:`V = n √ó 22.4 = ${n} √ó 22.4 = ${qObj.rawAns} L`});
            
            factSteps.push({t:"Plan", c:`g ‚ûú mol ‚ûú L`});
            factSteps.push({t:"‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á", c:`${m} <span class="cut-unit">g</span> √ó [1 <span class="cut-unit">mol</span>/${chem.mw} <span class="cut-unit">g</span>] √ó [22.4 L/1 <span class="cut-unit">mol</span>]`});
        }
        else if (type === 'L_to_g' && chem.atoms.O) { // Vol -> Mass
            let n = Math.floor(Math.random()*2) + 1;
            let v = n * 22.4;
            qObj.rawAns = n * chem.mw;
            qObj.q = `‡πÅ‡∏Å‡πä‡∏™ <b>${chem.f}</b> ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ <b>${v} L</b> (STP) ‡∏°‡∏µ‡∏°‡∏ß‡∏•‡∏Å‡∏µ‡πà‡∏Å‡∏£‡∏±‡∏°? <br>(MW=${chem.mw})`;
            qObj.hint = "Step 1: L ‚ûú mol, Step 2: mol ‚ûú g";

            formSteps.push({t:"Step 1: ‡∏´‡∏≤‡πÇ‡∏°‡∏•", c:`n = V/22.4 = ${v}/22.4 = ${n} mol`});
            formSteps.push({t:"Step 2: ‡∏´‡∏≤‡∏°‡∏ß‡∏•", c:`m = n √ó MW = ${n} √ó ${chem.mw} = ${qObj.rawAns} g`});

            factSteps.push({t:"Plan", c:`L ‚ûú mol ‚ûú g`});
            factSteps.push({t:"‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á", c:`${v} <span class="cut-unit">L</span> √ó [1 <span class="cut-unit">mol</span>/22.4 <span class="cut-unit">L</span>] √ó [${chem.mw} g/1 <span class="cut-unit">mol</span>]`});
        }
        else { // g -> N (Particles)
            let n = 0.5;
            let m = n * chem.mw;
            qObj.rawAns = 3.01;
            qObj.q = `‡∏™‡∏≤‡∏£ <b>${chem.f}</b> ‡∏°‡∏ß‡∏• <b>${m} g</b> ‡∏°‡∏µ‡∏Å‡∏µ‡πà‡πÇ‡∏°‡πÄ‡∏•‡∏Å‡∏∏‡∏•? <br>(MW=${chem.mw})`;
            qObj.hint = "(‡∏ï‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ √ó 10¬≤¬≥)";

            formSteps.push({t:"Step 1: ‡∏´‡∏≤‡πÇ‡∏°‡∏•", c:`n = ${m}/${chem.mw} = 0.5 mol`});
            formSteps.push({t:"Step 2: ‡∏´‡∏≤‡∏≠‡∏ô‡∏∏‡∏†‡∏≤‡∏Ñ", c:`N = 0.5 √ó 6.02 = 3.01 √ó 10¬≤¬≥`});

            factSteps.push({t:"Plan", c:`g ‚ûú mol ‚ûú molecule`});
            factSteps.push({t:"‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á", c:`${m} <span class="cut-unit">g</span> √ó [1 <span class="cut-unit">mol</span>/${chem.mw} <span class="cut-unit">g</span>] √ó [6.02√ó10¬≤¬≥ / 1 <span class="cut-unit">mol</span>]`});
        }

        qObj.factSteps = factSteps;
        qObj.formSteps = formSteps;
        finalizeQuest(qObj);
    }

    function finalizeQuest(qObj) {
        g.qData = qObj;
        g.ans = parseFloat(qObj.rawAns.toFixed(2));
        
        const qBox = document.getElementById('q-box');
        if(qBox) {
            let badge = g.isBonus ? `<div class="bonus-badge">‚òÖ BONUS x2 ‚òÖ</div>` : '';
            qBox.innerHTML = `
                ${badge}
                <div class="topic-tag">${qObj.topic}</div>
                <div style="font-size:1.2em; padding-top:10px;">${qObj.q}</div>
                <div class="format-hint">${qObj.hint}</div>
            `;
        }
    }

    // --- CHECK & RENDER STEPS ---
    function checkAns(forceFail=false) {
        clearInterval(g.timer);
        let u = parseFloat(document.getElementById('ans-in').value);
        g.isCorrect = false;
        
        if(!forceFail && !isNaN(u)) {
            if(Math.abs(u - g.ans) <= 0.1 || Math.abs((u-g.ans)/g.ans) < 0.05) g.isCorrect = true;
        }

        const feed = document.getElementById('feed-box');
        const btn = document.getElementById('btn-action');
        const title = document.getElementById('res-title');
        
        if(g.isCorrect) {
            sfx.play('correct');
            title.innerHTML = "<span style='color:#27ae60'>‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!</span>";
            feed.style.display = "none";
            btn.innerText = "üéÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•";
            btn.style.background = "var(--gold)";
            btn.onclick = goToReward;
            
            if(g.weaknessQueue.length > 0 && g.weaknessQueue[0] === g.qData.mode) {
                 g.weaknessQueue.shift(); 
                 alert("‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å! ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏≤‡∏ä‡∏ô‡∏∞‡∏à‡∏∏‡∏î‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß üéâ");
            }
        } else {
            sfx.play('wrong');
            title.innerHTML = "<span style='color:#c0392b'>‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</span>";
            g.hp -= 20;
            feed.innerHTML = `‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∑‡∏≠ ~ ${g.ans}`;
            feed.style.display = "block";
            btn.innerText = "‚û°Ô∏è ‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ";
            btn.style.background = "#95a5a6";
            btn.onclick = nextQuest;

            if(!g.isBonus && g.qData.mode !== undefined && !g.weaknessQueue.includes(g.qData.mode)) {
                g.weaknessQueue.push(g.qData.mode);
            }
        }

        renderSteps('sol-factor', g.qData.factSteps || []);
        renderSteps('sol-formula', g.qData.formSteps || []);

        switchTab('factor');
        document.getElementById('scr-tutor').style.display = 'flex';
        updateUI();
    }

    function renderSteps(id, steps) {
        let html = '';
        if(steps && steps.length > 0) {
            steps.forEach((s) => {
                html += `<div class="step-box">
                            <div class="step-title">${s.t}</div>
                            <div class="step-content">${s.c}</div>
                        </div>`;
            });
        } else {
             html = `<div style="text-align:center; padding:20px; color:#95a5a6;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏•‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ</div>`;
        }
        document.getElementById(id).innerHTML = html;
    }

    // --- SYSTEM FUNCTIONS ---
    function goToReward() {
        sfx.play('skill');
        document.getElementById('scr-tutor').style.display = 'none';
        document.getElementById('scr-reward').style.display = 'flex';
    }

    function claimReward(type) {
        if(Math.random() < 0.2) {
            if(g.cls === 'Dendro') {
                sfx.play('skill'); alert("üåø Dendro Passive: ‡∏û‡∏•‡∏±‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏≤‡∏õ!");
            } else {
                sfx.play('wrong');
                let dmg = 30; g.hp -= dmg;
                alert(`üò± ‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏î‡∏ô‡∏Ñ‡∏≥‡∏™‡∏≤‡∏õ! ‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏î ${dmg} HP`);
                document.getElementById('scr-reward').style.display = 'none';
                if(g.hp <= 0) { alert("Game Over"); resetGame(); return; }
                checkLevelUp(); return;
            }
        }
        
        sfx.play('level');
        let gain = g.isBonus ? 50 : 25; // x2 BONUS
        
        if(type === 'xp') { g.xp += gain; alert(`‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${gain} EXP!`); } 
        else if (type === 'mp') { g.mp = g.maxM; alert("‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π MP ‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏•‡∏≠‡∏î!"); }
        else if (type === 'cost') { g.skillCostMod = Math.max(0.5, g.skillCostMod - 0.1); alert("‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ MP ‡∏Ç‡∏≠‡∏á‡∏™‡∏Å‡∏¥‡∏•‡∏•‡∏á!"); }
        
        document.getElementById('scr-reward').style.display = 'none';
        checkLevelUp();
    }

    function checkLevelUp() {
        if(g.xp >= 100) {
            g.lv++; g.xp = 0; g.maxH += 20; g.hp = g.maxH;
            document.getElementById('u-icon').innerHTML = g.icon + `<div class="lv-badge">Lv.${g.lv}</div>`;
            alert(`üéâ Level Up! ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡πÄ‡∏ß‡∏• ${g.lv}`);
        }
        if(g.lv + g.midScore >= 14) {
            sfx.play('level');
            document.getElementById('win-total').innerText = (g.midScore + g.lv);
            document.getElementById('scr-win').style.display = 'flex';
        } else { nextQuest(); }
    }

    function nextQuest() {
        document.getElementById('scr-tutor').style.display='none';
        if(g.hp <= 0) { alert("Game Over"); resetGame(); } else genQuest();
    }

    function switchTab(t) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.sol-panel').forEach(p => p.classList.remove('active'));
        document.getElementById('btn-'+t).classList.add('active');
        document.getElementById('sol-'+t).classList.add('active');
    }

    function startTimer() {
        g.timer = setInterval(() => {
            g.tLeft--; updateUI();
            if(g.tLeft<=0) { clearInterval(g.timer); checkAns(true); }
        }, 1000);
    }

    function useSkill(k, base) {
        let cost = Math.floor(base * g.skillCostMod);
        if(g.mp < cost) return alert("MP ‡πÑ‡∏°‡πà‡∏û‡∏≠!");
        sfx.play('skill'); g.mp -= cost;
        if(k==='heal') g.hp = Math.min(g.maxH, g.hp+40);
        if(k==='time') g.tLeft += 20;
        if(k==='skip') genQuest();
        if(k==='hint') alert("Hint: ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÉ‡∏´‡πâ ‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ñ‡∏≤‡∏°");
        updateUI();
    }

    function updateUI() {
        if(document.getElementById('hp-bar')) document.getElementById('hp-bar').style.width = Math.max(0, g.hp/g.maxH*100)+'%';
        if(document.getElementById('mp-bar')) document.getElementById('mp-bar').style.width = (g.mp/g.maxM*100)+'%';
        if(document.getElementById('xp-bar')) document.getElementById('xp-bar').style.width = g.xp+'%';
        if(document.getElementById('t-bar')) document.getElementById('t-bar').style.width = (g.tLeft/g.tMax*100)+'%';
        
        if(document.getElementById('hp-txt')) document.getElementById('hp-txt').innerText = `${Math.floor(g.hp)}/${g.maxH}`;
        if(document.getElementById('mp-txt')) document.getElementById('mp-txt').innerText = `${g.mp}`;
        if(document.getElementById('t-txt')) document.getElementById('t-txt').innerText = `${g.tLeft}s`;
    }
</script>
</body>
</html>