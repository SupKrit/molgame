<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mol Impact: Exam Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&family=Kanit:wght@400;600;800;900&display=swap'); 
        :root {
            --bg-dark: #020617;
            --primary: #6366f1;
            --accent: #f43f5e;
            --gold: #fbbf24;
            --cyan: #06b6d4;
            --glass: rgba(30, 41, 59, 0.85);
            --glass-border: rgba(255, 255, 255, 0.15);
            --poison: #a855f7;
            --curse: #581c87;
        }
        body { 
            font-family: 'Sarabun', sans-serif; 
            background: #0f172a;
            color: #f1f5f9; margin: 0; position: fixed; inset:0; 
            overflow: hidden; display: flex; justify-content: center; user-select: none;
        }
        #app { 
            width: 100%; max-width: 480px; height: 100%; 
            display: flex; flex-direction: column; position: relative; 
            background: url('https://www.transparenttextures.com/patterns/stardust.png'), radial-gradient(circle at 50% 0%, #1e1b4b, #020617);
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            transition: 0.3s;
        }

        /* --- UI COMPONENTS --- */
        .screen { 
            position: absolute; inset: 0; z-index: 10; 
            background: var(--bg-dark); 
            display: none; flex-direction: column; overflow-y: auto; 
            padding-bottom: 20px;
        }
        .active { display: flex !important; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
        
        .btn {
            background: linear-gradient(135deg, var(--primary), #4338ca);
            color: white; border: none; padding: 12px; border-radius: 12px;
            font-family: 'Kanit'; font-size: 1rem; cursor: pointer; 
            width: 100%; transition: 0.2s; position: relative;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3); text-transform: uppercase; letter-spacing: 0.5px;
        }
        .btn:active { transform: translateY(2px); box-shadow: none; }
        .btn-green { background: linear-gradient(135deg, #10b981, #047857); }
        .btn-red { background: linear-gradient(135deg, var(--accent), #9f1239); }
        .btn-cyan { background: linear-gradient(135deg, var(--cyan), #0891b2); }
        
        .input-box {
            background: rgba(15, 23, 42, 0.8); border: 1px solid var(--glass-border);
            color: white; padding: 12px; border-radius: 12px;
            font-family: 'Kanit'; font-size: 1.3em; text-align: center;
            outline: none; width: 100%; box-sizing: border-box; transition: 0.3s;
        }
        .input-box:focus { border-color: var(--gold); box-shadow: 0 0 15px rgba(251, 191, 36, 0.2); }
        
        /* --- HUD --- */
        .hud {
            padding: 10px 15px; background: linear-gradient(180deg, rgba(15,23,42,0.95) 0%, rgba(15,23,42,0) 100%);
            display: flex; gap: 10px; z-index: 50; flex-shrink: 0;
        }
        .char-frame {
            position: relative; width: 60px; height: 60px;
            background: linear-gradient(135deg, #334155, #0f172a);
            border-radius: 14px; border: 2px solid var(--glass-border);
            display: flex; justify-content: center; align-items: center; font-size: 2.5em;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .poison-indicator {
            position: absolute; top: -5px; right: -5px; background: var(--poison);
            width: 20px; height: 20px; border-radius: 50%; font-size: 12px;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid #fff; z-index: 10; animation: pulse 1s infinite;
        }
        .lv-badge {
            position: absolute; bottom: -8px; background: var(--gold); color: #000;
            font-size: 0.7em; font-weight: 900; padding: 2px 6px; border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3); font-family: 'Kanit';
        }
        .stat-group { flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 4px; }
        .bar-row { display: flex; align-items: center; gap: 6px; font-size: 0.75em; font-weight: 600; color: #cbd5e1; }
        .bar-bg { flex: 1; height: 8px; background: rgba(0,0,0,0.6); border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 4px; transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        
        /* --- STAGE --- */
        .stage { flex: 1; display: flex; justify-content: space-around; align-items: center; position: relative; }
        .sprite { font-size: 6em; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)); transition: 0.3s; position: relative; }
        
        /* --- PANEL & FACTOR --- */
        .panel {
            background: rgba(15, 23, 42, 0.95); border-radius: 24px 24px 0 0;
            padding: 20px; backdrop-filter: blur(10px); border-top: 1px solid var(--glass-border);
            box-shadow: 0 -10px 50px rgba(0,0,0,0.6); display: flex; flex-direction: column;
            z-index: 60;
        }
        .q-card {
            background: rgba(30, 41, 59, 0.4); border: 1px solid var(--glass-border);
            border-radius: 16px; padding: 15px; text-align: center; position: relative;
            margin-bottom: 15px;
        }
        .bonus-tag { 
            position: absolute; top: -10px; right: 10px; background: var(--accent); 
            color: white; font-size: 0.7em; padding: 2px 8px; border-radius: 10px;
            font-weight: bold; box-shadow: 0 0 10px var(--accent); animation: pulse 1s infinite;
        }

        /* --- FACTOR CSS --- */
        .factor-container {
            display: flex; flex-wrap: wrap; align-items: center; justify-content: flex-start; gap: 5px; row-gap: 15px;
        }
        .fraction { 
            display: inline-flex; flex-direction: column; vertical-align: middle; text-align: center; margin: 0 2px;
            font-size: 0.9em; 
        }
        .frac-top { 
            border-bottom: 2px solid #cbd5e1; padding: 2px 6px; 
            font-weight: 600; color: var(--primary); line-height: 1.2;
            white-space: nowrap;
        }
        .frac-bot { 
            padding: 2px 6px; 
            font-weight: 600; color: var(--accent); line-height: 1.2;
            white-space: nowrap;
        }
        .u-canc { opacity: 0.6; text-decoration: line-through; color: #94a3b8; }
        .x-sign { font-weight: bold; color: #94a3b8; margin: 0 2px; }

        /* Chest & Calc */
        .chest-grid { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
        .chest-item {
            width: 80px; height: 80px;
            background: linear-gradient(to bottom, #f59e0b, #92400e);
            border: 3px solid #fcd34d; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5em; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            transition: transform 0.1s;
        }
        .chest-item:hover { transform: scale(1.02); }
        .chest-item:active { transform: scale(0.95); }

        .ios-calc-btn {
            width: 50px; height: 50px; background: #ff9500; border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 4px 0 #b45309; flex-shrink: 0;
        }
        .ios-calc-btn:active { transform: translateY(2px); box-shadow: none; }
        
        /* IMPROVED CALCULATOR STYLE */
        .calc-overlay {
            position: absolute; bottom: 0; left: 0; right: 0;
            height: 65%; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå */
            background: #1e293b; border-radius: 24px 24px 0 0; z-index: 100;
            display: none; flex-direction: column; 
            padding: 15px;
            box-sizing: border-box;
            border-top: 2px solid var(--cyan); animation: slideUp 0.3s;
            box-shadow: 0 -10px 50px rgba(0,0,0,0.9);
        }
        
        .calc-q-box {
            background: rgba(15,23,42,0.6); border: 1px solid var(--cyan);
            padding: 10px; border-radius: 12px; margin-bottom: 10px;
            font-size: 0.9em; color: #cbd5e1;
            max-height: 60px; overflow-y: auto; flex-shrink: 0;
        }

        .calc-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); 
            gap: 10px;
            flex: 1;
            max-width: 400px; margin: 0 auto; width: 100%;
        }
        .c-btn {
            background: #334155; color: white; border: none; border-radius: 12px;
            font-size: 1.4em; font-family: 'Kanit'; font-weight: 600;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3); transition: 0.1s;
        }
        .c-btn:active { transform: translateY(3px); box-shadow: none; }
        .c-op { background: var(--gold); color: black; font-size: 1.6em; }
        
        /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡∏Å‡∏Ç‡∏≠‡∏ö */
        #c-disp {
            width: 100%; box-sizing: border-box;
            background: rgba(0,0,0,0.3); border-radius: 8px;
            padding: 5px 10px;
            white-space: nowrap; overflow: hidden;
        }
        
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }

        /* Sol Box */
        .sol-box {
            background: white; color: #1e293b; border-radius: 16px; 
            max-width: 500px; width: 95%; margin: auto; max-height: 90vh; display: flex; flex-direction: column;
            overflow: hidden;
        }
        .sol-content { padding: 20px; overflow-y: auto; font-size: 0.95em; line-height: 1.6; }
        
        /* Skills & Class */
        .skill-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
        .sk-btn { 
            padding: 8px 4px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 65px;
        }
        .sk-name { font-size: 0.85em; font-weight: bold; line-height: 1.2; }
        .sk-cost { font-size: 0.7em; opacity: 0.9; margin-top: 2px; }

        .cls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .cls-card {
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
            padding: 15px; border-radius: 16px; text-align: center; cursor: pointer;
            display: flex; flex-direction: column; align-items: center;
        }

        /* Animations */
        @keyframes atk-r { 0%{transform:translateX(0) scaleX(-1)} 50%{transform:translateX(80px) scaleX(-1)} 100%{transform:translateX(0) scaleX(-1)} }
        @keyframes atk-l { 0%{transform:translateX(0)} 50%{transform:translateX(-80px)} 100%{transform:translateX(0)} }
        
        @keyframes shake-screen { 
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        @keyframes flash-red { 0%{box-shadow: inset 0 0 0 red;} 50%{box-shadow: inset 0 0 100px red;} 100%{box-shadow: inset 0 0 0 red;} }
        @keyframes flash-green { 0%{box-shadow: inset 0 0 0 #10b981;} 50%{box-shadow: inset 0 0 50px #10b981;} 100%{box-shadow: inset 0 0 0 #10b981;} }
        
        .anim-atk-hero { animation: atk-r 0.3s ease-in-out; }
        .anim-atk-enemy { animation: atk-l 0.3s ease-in-out; }
        .anim-shake-screen { animation: shake-screen 0.5s; }
        .anim-dmg { animation: flash-red 0.5s; }
        .anim-correct { animation: flash-green 0.5s; }

        .calc-mode .stage { flex: 0; height: 100px; min-height: 100px; overflow: hidden; } 
        .calc-mode .skill-grid { display: none; }
    </style>
</head>
<body>
<div id="app">
    <div id="scr-landing" class="screen active" style="align-items:center; justify-content:center;">
        <div style="text-align:center; animation: fadeIn 1s;">
            <div style="font-size:3.5em; font-family:'Kanit'; font-weight:900; line-height:1; color:white; text-shadow:0 0 40px var(--primary);">MOL<br><span style="color:var(--primary)">IMPACT</span></div>
            <div style="color:var(--cyan); letter-spacing:5px; font-size:0.8em; margin-top:10px; font-weight:600;">EXAM EDITION</div>
        </div>
        <div style="width:80%; max-width:320px; margin-top:40px;">
            <input type="text" id="p-name" class="input-box" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô (Nickname)" maxlength="10">
            <div style="margin-top:15px; background:rgba(251, 191, 36, 0.15); padding:10px; border-radius:10px; border:1px dashed var(--gold); text-align:center;">
                <b style="color:var(--gold);">üèÜ ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏Å‡πâ</b><br>
                <span style="font-size:0.85em; color:#cbd5e1;">‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ <b>14 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</b> ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ<br>(‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö + ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏ô‡πÄ‡∏Å‡∏°) ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏ú‡πà‡∏≤‡∏ô!</span>
            </div>
            <button class="btn" onclick="checkName()" style="margin-top:15px;">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
            <button class="btn" style="margin-top:10px; background:transparent; border:1px solid #475569;" onclick="showScreen('scr-howto')">üìú ‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏•‡πà‡∏ô</button>
        </div>
    </div>

    <div id="scr-howto" class="screen" style="padding:25px;">
        <h2 style="color:var(--gold); text-align:center; margin-bottom:10px;">üìú ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏ô‡∏±‡∏Å‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡πÄ‡∏Ñ‡∏°‡∏µ</h2>
        <div style="background:rgba(255,255,255,0.1); padding:20px; border-radius:16px; font-size:0.95em; line-height:1.7;">
            <div style="margin-bottom:15px;">
                <b style="color:var(--cyan); font-size:1.1em;">1. ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</b><br>
                ‡∏ï‡∏≠‡∏ö‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÄ‡∏Ñ‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö XP ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô!
            </div>
            <div style="margin-bottom:15px;">
                <b style="color:var(--accent); font-size:1.1em;">2. ‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ</b><br>
                ‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å: ‡πÇ‡∏à‡∏°‡∏ï‡∏µ + ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•<br>
                ‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î: ‡πÇ‡∏î‡∏ô‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡∏™‡∏ß‡∏ô‡∏Å‡∏•‡∏±‡∏ö!
            </div>
            <div style="margin-bottom:15px;">
                <b style="color:var(--poison); font-size:1.1em;">3. ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å!</b><br>
                <ul>
                    <li><b>‡∏û‡∏¥‡∏© (Poison):</b> ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏•‡∏î 2 ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏∏‡∏Å‡∏ï‡∏≤</li>
                    <li><b>‡∏Ñ‡∏≥‡∏™‡∏≤‡∏õ (Curse):</b> ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏•‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ 10 ‡∏´‡∏ô‡πà‡∏ß‡∏¢!</li>
                </ul>
            </div>
        </div>
        <button class="btn btn-cyan" style="margin-top:20px;" onclick="showScreen('scr-landing')">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
    </div>

    <div id="scr-class" class="screen" style="padding:25px;">
        <h2 style="text-align:center; color:var(--gold);">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
        <div style="text-align:center; margin-bottom:15px;">
            <label style="color:#94a3b8; font-size:0.9em;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ (0-20)</label>
            <input type="number" id="mid-score" class="input-box" style="padding:8px; font-size:1em; width:120px; margin-top:5px;" placeholder="‡πÉ‡∏™‡πà‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô">
        </div>
        <div class="cls-grid">
            <div class="cls-card" onclick="startGame('Pyro')">
                <div style="font-size:35px;">üî•</div><div style="font-weight:bold; color:var(--accent);">Pyro</div>
                <div style="font-size:0.75em; color:#cbd5e1;">Max HP ‡∏™‡∏π‡∏á</div>
            </div>
            <div class="cls-card" onclick="startGame('Hydro')">
                <div style="font-size:35px;">üíß</div><div style="font-weight:bold; color:var(--primary);">Hydro</div>
                <div style="font-size:0.75em; color:#cbd5e1;">Max MP ‡∏™‡∏π‡∏á</div>
            </div>
            <div class="cls-card" onclick="startGame('Dendro')">
                <div style="font-size:35px;">üåø</div><div style="font-weight:bold; color:#10b981;">Dendro</div>
                <div style="font-size:0.75em; color:#cbd5e1;">EXP Bonus</div>
            </div>
            <div class="cls-card" onclick="startGame('Electro')">
                <div style="font-size:35px;">‚ö°</div><div style="font-weight:bold; color:var(--gold);">Electro</div>
                <div style="font-size:0.75em; color:#cbd5e1;">Lucky</div>
            </div>
        </div>
    </div>

    <div id="scr-game" class="screen">
        <div class="hud">
            <div class="char-frame" onclick="showStats()">
                <span id="p-icon">üßô‚Äç‚ôÇÔ∏è</span>
                <div class="lv-badge" id="lv-txt">Lv.1</div>
                <div id="poison-mark" class="poison-indicator" style="display:none;">‚ò†Ô∏è</div>
            </div>
            <div class="stat-group">
                <div class="bar-row">
                    <span>HP</span><div class="bar-bg"><div id="hp-bar" class="bar-fill" style="width:100%; background:var(--accent);"></div></div>
                </div>
                <div class="bar-row">
                    <span>MP</span><div class="bar-bg"><div id="mp-bar" class="bar-fill" style="width:100%; background:var(--primary);"></div></div>
                </div>
                <div class="bar-row">
                    <span style="color:var(--gold)">XP</span><div class="bar-bg"><div id="xp-bar" class="bar-fill" style="width:0%; background:var(--gold);"></div></div>
                </div>
                <div class="bar-row" style="margin-top:2px; justify-content:space-between;">
                    <span id="score-txt" style="color:var(--cyan); font-weight:bold;">0 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                </div>
            </div>
        </div>
        <div style="height:4px; background:black; width:100%; flex-shrink:0;"><div id="time-bar" style="height:100%; width:100%; background:var(--cyan); transition: width 1s linear;"></div></div>
        <div class="stage">
            <div class="sprite" id="hero-img" style="transform: scaleX(-1);">üßô‚Äç‚ôÇÔ∏è</div>
            <div class="sprite" id="enemy-img">üëæ</div>
        </div>
        <div class="panel">
            <div class="skill-grid">
                <button class="btn btn-green sk-btn" onclick="useSkill('heal')">
                    <span class="sk-name">üíñ Heal</span><span class="sk-cost">20 MP</span>
                </button>
                <button class="btn btn-cyan sk-btn" onclick="useSkill('time')">
                    <span class="sk-name">‚è≥ Time</span><span class="sk-cost">15 MP</span>
                </button>
                <button class="btn sk-btn" style="background:#475569;" onclick="useSkill('hint')">
                    <span class="sk-name">üí° Hint</span><span class="sk-cost">10 MP</span>
                </button>
                <button class="btn btn-red sk-btn" onclick="useSkill('skip')">
                    <span class="sk-name">‚è≠Ô∏è Skip</span><span class="sk-cost">30 MP</span>
                </button>
            </div>
            <div class="q-card" id="q-card-box">
                <div id="bonus-badge" class="bonus-tag" style="display:none;">üî• BONUS</div>
                <div style="font-size:0.9em; color:var(--primary); font-weight:bold; font-family:'Kanit';" id="q-topic">TOPIC</div>
                <div id="q-main" style="font-size:1.1em; font-weight:bold; margin:8px 0;">...</div>
                <div id="q-sub" style="color:#94a3b8; font-size:0.9em; display:none;"></div>
                <div id="q-hint-box" style="display:none; margin-top:5px; padding:8px; background:rgba(251,191,36,0.1); border-radius:8px; color:var(--gold); font-size:1em; font-weight:bold; border:1px dashed var(--gold);"></div>
            </div>
            <form id="ans-form" style="display:flex; gap:10px;">
                <div class="ios-calc-btn" onclick="toggleCalc()">
                    <svg viewBox="0 0 24 24" width="24" height="24" stroke="white" stroke-width="3" fill="none"><path d="M6 3 L6 21 M3 6 L21 6 M16 16 L20 20 M20 16 L16 20"></path></svg>
                </div>
                <input type="number" id="ans-in" class="input-box" placeholder="‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö" step="any" autocomplete="off">
                <button type="submit" class="btn" style="width:auto; min-width:80px;">‚öîÔ∏è</button>
            </form>
        </div>
    </div>

    <div id="scr-result" class="screen" style="background:rgba(0,0,0,0.85); align-items:center; justify-content:center; padding:10px;">
        <div class="sol-box">
            <div style="padding:15px; background:#f1f5f9; text-align:center; border-bottom:1px solid #e2e8f0;">
                <h2 id="res-title" style="margin:0;"></h2>
                <div id="res-reward" style="margin-top:10px; color:#d97706; font-weight:bold; display:none;"></div>
                <p style="margin:5px 0 0; color:#64748b; font-size:0.9em;">‡∏ï‡∏≠‡∏ö: <b id="tut-ans" style="color:var(--primary)"></b></p>
            </div>
            <div class="sol-content" id="sol-content"></div>
            <button id="res-btn" class="btn" style="border-radius:0; margin-top:auto;" onclick="closeResult()">‡πÑ‡∏õ‡∏ï‡πà‡∏≠</button>
        </div>
    </div>

    <div id="scr-chest" class="screen" style="background:rgba(0,0,0,0.9); align-items:center; justify-content:center; padding:20px;">
        <div style="text-align:center;">
            <div style="font-size:3em; margin-bottom:10px;">üóùÔ∏è</div>
            <h2 style="color:var(--gold); margin:0;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏µ‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</h2>
            <div class="chest-grid">
                <div class="chest-item" onclick="selectChest(1)">üì¶</div>
                <div class="chest-item" onclick="selectChest(2)">üì¶</div>
                <div class="chest-item" onclick="selectChest(3)">üì¶</div>
            </div>
            <div id="chest-result" style="margin-top:20px; min-height:50px; font-size:1.1em; font-weight:bold;"></div>
            <button id="chest-next-btn" class="btn" onclick="finishChest()" style="margin-top:20px; display:none; width:200px; margin-left:auto; margin-right:auto;">‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏ï‡πà‡∏≠</button>
        </div>
    </div>

    <div id="scr-win" class="screen" style="background:rgba(0,0,0,0.95); align-items:center; justify-content:center; text-align:center;">
        <div style="font-size:5em;">üèÜ</div>
        <h1 style="color:var(--gold);">CONGRATS!</h1>
        <p>‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß!</p>
        <p>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: <span id="final-score"></span></p>
        <button class="btn" style="width:200px; margin-top:20px;" onclick="resetGame()">‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
    </div>

    <div id="calc" class="calc-overlay">
        <div class="calc-q-box" id="calc-q-display">
            ‡πÇ‡∏à‡∏ó‡∏¢‡πå: ...
        </div>
        
        <input id="c-disp" type="text" readonly style="font-size:2.5em; text-align:right; font-family:'Kanit'; color:white; border:none; margin-bottom:10px;" placeholder="0">
        
        <div class="calc-grid">
            <button onclick="cClr()" class="c-btn" style="background:var(--accent);">C</button>
            <button onclick="cDel()" class="c-btn" style="background:#475569;">‚Üê</button>
            <button onclick="cIn('/')" class="c-btn c-op">√∑</button>
            <button onclick="cIn('*')" class="c-btn c-op">√ó</button>
            <button onclick="cIn('7')" class="c-btn">7</button>
            <button onclick="cIn('8')" class="c-btn">8</button>
            <button onclick="cIn('9')" class="c-btn">9</button>
            <button onclick="cIn('-')" class="c-btn c-op">-</button>
            <button onclick="cIn('4')" class="c-btn">4</button>
            <button onclick="cIn('5')" class="c-btn">5</button>
            <button onclick="cIn('6')" class="c-btn">6</button>
            <button onclick="cIn('+')" class="c-btn c-op">+</button>
            <button onclick="cIn('1')" class="c-btn">1</button>
            <button onclick="cIn('2')" class="c-btn">2</button>
            <button onclick="cIn('3')" class="c-btn">3</button>
            <button onclick="cEval()" class="c-btn" style="grid-row:span 2; background:var(--primary); font-size:2em;">=</button>
            <button onclick="cIn('0')" class="c-btn" style="grid-column:span 2;">0</button>
            <button onclick="cIn('.')" class="c-btn">.</button>
        </div>
        <div style="text-align:center; color:#94a3b8; margin-top:10px; cursor:pointer; padding:5px;" onclick="toggleCalc()">üîª ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç</div>
    </div>
</div>

<script>
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioCtx();
    
    function playSfx(type) {
        if(ctx.state === 'suspended') ctx.resume();
        const osc = ctx.createOscillator(); const gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        const now = ctx.currentTime;
        
        if(type==='atk'){ 
            osc.frequency.setValueAtTime(800,now); osc.frequency.exponentialRampToValueAtTime(1200,now+0.1); 
            gain.gain.setValueAtTime(0.3,now); gain.gain.linearRampToValueAtTime(0,now+0.3); 
            osc.start(now); osc.stop(now+0.3); 
        }
        else if(type==='wrong'){
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150,now); osc.frequency.linearRampToValueAtTime(80,now+0.4); 
            gain.gain.setValueAtTime(0.5,now); gain.gain.linearRampToValueAtTime(0,now+0.4); 
            osc.start(now); osc.stop(now+0.4); 
        }
        else if(type==='win'){ 
            osc.type='triangle'; osc.frequency.setValueAtTime(523.25, now); osc.frequency.setValueAtTime(659.25, now + 0.1);
            osc.frequency.setValueAtTime(783.99, now + 0.2); osc.frequency.setValueAtTime(1046.50, now + 0.3);
            gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.6); 
            osc.start(now); osc.stop(now + 0.6); 
        }
    }

    // EXPANDED DATABASE
    const DB = [
        { f:"H‚ÇÇO", mw:18, d:1.0, type:'covalent', atom:{'H':2,'O':1}, total:3, n:"‡∏ô‡πâ‡∏≥" },
        { f:"CO‚ÇÇ", mw:44, d:null, type:'covalent', atom:{'C':1,'O':2}, total:3, n:"‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏≠‡∏ô‡πÑ‡∏î‡∏≠‡∏≠‡∏Å‡πÑ‡∏ã‡∏î‡πå" },
        { f:"CH‚ÇÑ", mw:16, d:0.66, type:'covalent', atom:{'C':1,'H':4}, total:5, n:"‡∏°‡∏µ‡πÄ‡∏ó‡∏ô" },
        { f:"NH‚ÇÉ", mw:17, d:0.77, type:'covalent', atom:{'N':1,'H':3}, total:4, n:"‡πÅ‡∏≠‡∏°‡πÇ‡∏°‡πÄ‡∏ô‡∏µ‡∏¢" },
        { f:"C‚ÇÜH‚ÇÅ‚ÇÇO‚ÇÜ", mw:180, d:1.54, type:'covalent', atom:{'C':6,'H':12,'O':6}, total:24, n:"‡∏Å‡∏•‡∏π‡πÇ‡∏Ñ‡∏™" },
        { f:"H‚ÇÇSO‚ÇÑ", mw:98, d:1.83, type:'covalent', atom:{'H':2,'S':1,'O':4}, total:7, n:"‡∏Å‡∏£‡∏î‡∏ã‡∏±‡∏•‡∏ü‡∏¥‡∏ß‡∏£‡∏¥‡∏Å" },
        { f:"NaCl", mw:58.5, d:2.16, type:'ionic', atom:{'Na':1,'Cl':1}, total:2, n:"‡πÇ‡∏ã‡πÄ‡∏î‡∏µ‡∏¢‡∏°‡∏Ñ‡∏•‡∏≠‡πÑ‡∏£‡∏î‡πå" },
        { f:"CaCO‚ÇÉ", mw:100, d:2.71, type:'ionic', atom:{'Ca':1,'C':1,'O':3}, total:5, n:"‡πÅ‡∏Ñ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢‡∏°‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏≠‡πÄ‡∏ô‡∏ï" },
        { f:"KMnO‚ÇÑ", mw:158, d:2.7, type:'ionic', atom:{'K':1,'Mn':1,'O':4}, total:6, n:"‡∏î‡πà‡∏≤‡∏á‡∏ó‡∏±‡∏ö‡∏ó‡∏¥‡∏°" },
        { f:"He", mw:4, d:null, type:'element', atom:{'He':1}, total:1, n:"‡∏Æ‡∏µ‡πÄ‡∏•‡∏µ‡∏¢‡∏°" },
        { f:"Ne", mw:20, d:null, type:'element', atom:{'Ne':1}, total:1, n:"‡∏ô‡∏µ‡∏≠‡∏≠‡∏ô" },
        { f:"Fe", mw:56, d:7.87, type:'element', atom:{'Fe':1}, total:1, n:"‡πÄ‡∏´‡∏•‡πá‡∏Å" },
        { f:"HNO‚ÇÉ", mw:63, d:1.51, type:'covalent', atom:{'H':1,'N':1,'O':3}, total:5, n:"‡∏Å‡∏£‡∏î‡πÑ‡∏ô‡∏ó‡∏£‡∏¥‡∏Å" },
        { f:"NaOH", mw:40, d:2.13, type:'ionic', atom:{'Na':1,'O':1,'H':1}, total:3, n:"‡πÇ‡∏ã‡∏î‡∏≤‡πÑ‡∏ü" },
        { f:"C‚ÇÇH‚ÇÖOH", mw:46, d:0.79, type:'covalent', atom:{'C':2,'H':6,'O':1}, total:9, n:"‡πÄ‡∏≠‡∏ó‡∏≤‡∏ô‡∏≠‡∏•" },
        { f:"CuSO‚ÇÑ", mw:159.5, d:3.6, type:'ionic', atom:{'Cu':1,'S':1,'O':4}, total:6, n:"‡∏à‡∏∏‡∏ô‡∏™‡∏µ" },
        { f:"O‚ÇÇ", mw:32, d:null, type:'element', atom:{'O':2}, total:2, n:"‡∏≠‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏à‡∏ô" },
        { f:"N‚ÇÇ", mw:28, d:null, type:'element', atom:{'N':2}, total:2, n:"‡πÑ‡∏ô‡πÇ‡∏ï‡∏£‡πÄ‡∏à‡∏ô" },
        { f:"Cl‚ÇÇ", mw:71, d:null, type:'element', atom:{'Cl':2}, total:2, n:"‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡∏ô" }
    ];

    const TopicNames = {
        'mol_g': '‡πÇ‡∏°‡∏• ‚Æï ‡∏°‡∏ß‡∏• (g)',
        'g_mol': '‡∏°‡∏ß‡∏• (g) ‚Æï ‡πÇ‡∏°‡∏•',
        'mol_dm3': '‡πÇ‡∏°‡∏• ‚Æï ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡πÅ‡∏Å‡πä‡∏™ (STP)',
        'dm3_mol': '‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡πÅ‡∏Å‡πä‡∏™ (STP) ‚Æï ‡πÇ‡∏°‡∏•',
        'mol_part': '‡πÇ‡∏°‡∏• ‚Æï ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏∏‡∏†‡∏≤‡∏Ñ',
        'part_mol': '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏∏‡∏†‡∏≤‡∏Ñ ‚Æï ‡πÇ‡∏°‡∏•',
        'mol_atom_count': '‡πÇ‡∏°‡∏•‡∏™‡∏≤‡∏£ ‚Æï ‡πÇ‡∏°‡∏•‡∏≠‡∏∞‡∏ï‡∏≠‡∏°‡∏£‡∏ß‡∏°',
        'mol_elem_stoich': '‡πÇ‡∏°‡∏•‡∏™‡∏≤‡∏£ ‚Æï ‡πÇ‡∏°‡∏•‡∏ò‡∏≤‡∏ï‡∏∏‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö',
        'mw_calc': '‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏ß‡∏•‡πÇ‡∏°‡πÄ‡∏•‡∏Å‡∏∏‡∏• (MW)',
        'density_m_v': '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô: ‡∏°‡∏ß‡∏• ‚Æï ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£',
        'density_v_m': '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô: ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ ‚Æï ‡∏°‡∏ß‡∏•',
        'challenge_g_dm3': 'BONUS: ‡∏°‡∏ß‡∏• ‚Æï ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ (STP)',
        'challenge_part_g': 'BONUS: ‡∏≠‡∏ô‡∏∏‡∏†‡∏≤‡∏Ñ ‚Æï ‡∏°‡∏ß‡∏•'
    };

    const PositivePhrases = [
        "‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å! üëç", "‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡πÑ‡∏õ‡πÄ‡∏•‡∏¢! üåü", "‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö! ‚úÖ", 
        "‡πÄ‡∏â‡∏µ‡∏¢‡∏ö‡∏Ç‡∏≤‡∏î! ‚öîÔ∏è", "‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏¢‡∏≠‡∏î! ü§©", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏ô! ‚úåÔ∏è"
    ];

    let g = { hp:100, maxHp:100, mp:50, maxMp:50, xp:0, maxXp:25, lv:1, examScore:0, targetScore:14, q:null, timer:null, tMax:60, tCur:60, cls:'Pyro', isPoisoned:false, isBonus:false };

    function showScreen(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function checkName() { if(document.getElementById('p-name').value) { if(ctx.state==='suspended') ctx.resume(); showScreen('scr-class'); } }
    function startGame(cls) {
        let sc = parseInt(document.getElementById('mid-score').value);
        if(isNaN(sc)||sc<0||sc>20) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 0-20");
        g.examScore = sc; g.cls = cls; g.maxHp = (cls==='Pyro')?150:100; g.maxMp = (cls==='Hydro')?100:50;
        g.hp=g.maxHp; g.mp=g.maxMp; g.xp=0; g.lv=1; g.isPoisoned=false;
        updateHUD(); nextQuest(); showScreen('scr-game');
    }
    
    const factorBox = (steps) => {
        let h = `<div class="factor-container">`;
        steps.forEach((s,i) => {
            if(i>0) h+=`<div class="x-sign">√ó</div>`;
            h += `<div class="fraction"><span class="frac-top">${s.top}</span><span class="frac-bot">${s.bot}</span></div>`;
        });
        if(steps.length > 0 && steps[steps.length-1].res) {
            h += `<div>= <b style="color:var(--gold)">${steps[steps.length-1].res}</b></div>`;
        }
        h += `</div>`;
        return h;
    };
    
    const formulaBox = (vars, form, sub, ans) => {
        return `
            <div style="background:rgba(6,182,212,0.1); padding:8px; border-radius:8px; border-left:3px solid var(--cyan);">
                <div style="font-size:0.9em; color:#94a3b8; line-height:1.4;">${vars}</div>
                <div style="margin-top:4px;"><b>‡∏™‡∏π‡∏ï‡∏£:</b> ${form}</div>
                <div><b>‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤:</b> ${sub}</div>
                <div><b>‡∏ï‡∏≠‡∏ö:</b> <span style="color:var(--cyan); font-weight:bold;">${ans}</span></div>
            </div>
        `;
    }

    function getUnitName(type) {
        if(type === 'ionic') return { s:'fu', l:'‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏™‡∏π‡∏ï‡∏£' };
        if(type === 'element') return { s:'atom', l:'‡∏≠‡∏∞‡∏ï‡∏≠‡∏°' };
        return { s:'mc', l:'‡πÇ‡∏°‡πÄ‡∏•‡∏Å‡∏∏‡∏•' }; // CHANGED mc -> ‡πÇ‡∏°‡πÄ‡∏•‡∏Å‡∏∏‡∏• full text below
    }

    // FUNCTION TO GET HINT BASED ON TYPE
    function getHint(type) {
        if(type.includes('mol_g') || type.includes('g_mol')) return "n = g / MW";
        if(type.includes('dm3')) return "n = V_STP / 22.4";
        if(type.includes('part')) return "n = N / 6.02√ó10¬≤¬≥";
        if(type.includes('density')) return "d = m / V";
        if(type.includes('atom_count')) return "1 ‡πÇ‡∏°‡πÄ‡∏•‡∏Å‡∏∏‡∏• = ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏¢";
        return "‡∏ï‡∏±‡∏î‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£";
    }

    function genQuest() {
        cClr();
        document.getElementById('q-hint-box').style.display = 'none';
        document.getElementById('q-hint-box').innerHTML = '';

        g.isBonus = Math.random() < 0.2; 
        let c = DB[Math.floor(Math.random()*DB.length)];
        let n = (Math.random()*2 + 0.5).toFixed(1);
        let q = {};
        
        const topicsBasic = ['mol_g', 'g_mol', 'mol_dm3', 'dm3_mol', 'mol_part', 'part_mol', 'mw_calc'];
        const topicsAdv = ['mol_atom_count', 'mol_elem_stoich', 'density_m_v', 'density_v_m'];
        const topicsHard = ['challenge_g_dm3', 'challenge_part_g'];
        
        let pool = g.isBonus ? topicsHard : [...topicsBasic, ...topicsAdv];
        if(!c.d) pool = pool.filter(t => !t.includes('density'));
        
        let type = pool[Math.floor(Math.random()*pool.length)];
        let uInfo = getUnitName(c.type);
        q.hintText = getHint(type); // Store hint

        let unitNote = (uInfo.s === 'fu') ? " <span style='font-size:0.8em; color:var(--poison);'>(fu = ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏™‡∏π‡∏ï‡∏£)</span>" : "";

        // Using full text for molecule
        let txt_part = uInfo.l;
        let unit_part = uInfo.s === 'mc' ? '‡πÇ‡∏°‡πÄ‡∏•‡∏Å‡∏∏‡∏•' : uInfo.s;

        let u_mol = `<span class="u-canc">mol</span>`;
        let u_g = `<span class="u-canc">g</span>`;
        let u_dm3 = `<span class="u-canc">dm¬≥</span>`;
        let u_part = `<span class="u-canc">${unit_part}</span>`;
        
        let showMW = (type.includes('g') || type.includes('mw') || type === 'density_m_v' || type === 'density_v_m') ? ` (MW = ${c.mw})` : "";
        if(type === 'mw_calc') showMW = "";

        document.getElementById('bonus-badge').style.display = g.isBonus ? 'block' : 'none';

        switch(type) {
            case 'mol_g':
                q.ans = n * c.mw; q.unit = "g";
                q.txt = `${c.f}${showMW} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${n} mol ‡∏°‡∏µ‡∏°‡∏ß‡∏•‡∏Å‡∏µ‡πà‡∏Å‡∏£‡∏±‡∏°?`;
                q.sol1 = factorBox([{top:`${n} ${u_mol} ${c.f}`, bot:"1"}, {top:`${c.mw} g ${c.f}`, bot:`1 ${u_mol} ${c.f}`, res:`${q.ans.toFixed(2)} g`}]);
                q.desc = `‡∏ï‡∏±‡∏î‡∏´‡∏ô‡πà‡∏ß‡∏¢ mol ‡∏ó‡∏¥‡πâ‡∏á ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ g`;
                q.sol2 = formulaBox(
                    `<b>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£:</b><br>n (‡πÇ‡∏°‡∏•) = ${n} mol<br>MW (‡∏°‡∏ß‡∏•‡πÇ‡∏°‡πÄ‡∏•‡∏Å‡∏∏‡∏•) = ${c.mw} g/mol`, 
                    `m = n √ó MW <br><small style='color:#cbd5e1'>(m = ‡∏°‡∏ß‡∏•‡∏™‡∏≤‡∏£)</small>`, 
                    `m = ${n} √ó ${c.mw}`, 
                    `${q.ans.toFixed(2)} g`
                );
                break;
            case 'g_mol':
                let mass = (n * c.mw).toFixed(1); q.ans = mass/c.mw; q.unit = "mol";
                q.txt = `${c.f}${showMW} ‡∏°‡∏ß‡∏• ${mass} g ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏µ‡πà‡πÇ‡∏°‡∏•?`;
                q.sol1 = factorBox([{top:`${mass} ${u_g} ${c.f}`, bot:"1"}, {top:`1 mol ${c.f}`, bot:`${c.mw} ${u_g} ${c.f}`, res:`${q.ans.toFixed(2)} mol`}]);
                q.desc = `‡∏ï‡∏±‡∏î‡∏´‡∏ô‡πà‡∏ß‡∏¢ g ‡∏ó‡∏¥‡πâ‡∏á ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ mol`;
                q.sol2 = formulaBox(
                    `<b>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£:</b><br>m (‡∏°‡∏ß‡∏•‡∏™‡∏≤‡∏£) = ${mass} g<br>MW (‡∏°‡∏ß‡∏•‡πÇ‡∏°‡πÄ‡∏•‡∏Å‡∏∏‡∏•) = ${c.mw} g/mol`, 
                    `n = m / MW <br><small style='color:#cbd5e1'>(n = ‡πÇ‡∏°‡∏•)</small>`, 
                    `n = ${mass} / ${c.mw}`, 
                    `${q.ans.toFixed(2)} mol`
                );
                break;
            case 'mol_dm3':
                q.ans = n * 22.4; q.unit = "dm¬≥";
                q.txt = `${c.f} (STP) ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${n} mol ‡∏°‡∏µ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡πÄ‡∏ó‡πà‡∏≤‡πÉ‡∏î?`;
                q.sol1 = factorBox([{top:`${n} ${u_mol} ${c.f}`, bot:"1"}, {top:`22.4 dm¬≥ STP`, bot:`1 ${u_mol} ${c.f}`, res:`${q.ans.toFixed(2)} dm¬≥`}]);
                q.desc = `‡πÉ‡∏ä‡πâ 22.4 dm¬≥ ‡∏ó‡∏µ‡πà STP ‡∏ï‡πà‡∏≠ 1 mol`;
                q.sol2 = formulaBox(
                    `<b>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£:</b><br>n (‡πÇ‡∏°‡∏•) = ${n} mol<br>C (‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà STP) = 22.4 dm¬≥/mol`, 
                    `V = n √ó 22.4 <br><small style='color:#cbd5e1'>(V = ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ STP)</small>`, 
                    `V = ${n} √ó 22.4`, 
                    `${q.ans.toFixed(2)} dm¬≥`
                );
                break;
            case 'dm3_mol':
                let v = (n * 22.4).toFixed(1); q.ans = v/22.4; q.unit = "mol";
                q.txt = `${c.f} (STP) ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ ${v} dm¬≥ ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏µ‡πà‡πÇ‡∏°‡∏•?`;
                q.sol1 = factorBox([{top:`${v} ${u_dm3}`, bot:"1"}, {top:`1 mol ${c.f}`, bot:`22.4 ${u_dm3}`, res:`${q.ans.toFixed(2)} mol`}]);
                q.desc = `‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏°‡∏• ‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢ 22.4`;
                q.sol2 = formulaBox(
                    `<b>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£:</b><br>V (‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ STP) = ${v} dm¬≥`, 
                    `n = V / 22.4 <br><small style='color:#cbd5e1'>(n = ‡πÇ‡∏°‡∏•)</small>`, 
                    `n = ${v} / 22.4`, 
                    `${q.ans.toFixed(2)} mol`
                );
                break;
            case 'mol_part':
                q.ans = n * 6.02; q.unit = "√ó10¬≤¬≥";
                q.txt = `${c.f} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${n} mol ‡∏°‡∏µ‡∏Å‡∏µ‡πà${txt_part}? ${unitNote}<br>(‡∏ï‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏•‡∏Ç‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ √ó10¬≤¬≥)`;
                q.sol1 = factorBox([{top:`${n} ${u_mol} ${c.f}`, bot:"1"}, {top:`6.02√ó10¬≤¬≥ ${unit_part}`, bot:`1 ${u_mol} ${c.f}`, res:`${q.ans.toFixed(2)}√ó10¬≤¬≥ ${unit_part}`}]);
                q.desc = `‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏Ç‡∏≠‡∏≤‡πÇ‡∏ß‡∏Å‡∏≤‡πÇ‡∏î‡∏£ 6.02√ó10¬≤¬≥ ‡∏ï‡πà‡∏≠ 1 mol`;
                q.sol2 = formulaBox(
                    `<b>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£:</b><br>n (‡πÇ‡∏°‡∏•) = ${n} mol<br>Av (‡πÄ‡∏•‡∏Ç‡∏≠‡∏≤‡πÇ‡∏ß‡∏Å‡∏≤‡πÇ‡∏î‡∏£) = 6.02√ó10¬≤¬≥`, 
                    `N = n √ó 6.02√ó10¬≤¬≥ <br><small style='color:#cbd5e1'>(N = ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏∏‡∏†‡∏≤‡∏Ñ)</small>`, 
                    `N = ${n} √ó 6.02 (‡∏ï‡∏±‡∏î 10¬≤¬≥ ‡πÑ‡∏ß‡πâ‡∏ï‡∏≠‡∏ö‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢)`, 
                    `${q.ans.toFixed(2)}√ó10¬≤¬≥`
                );
                break;
            case 'part_mol':
                let p = (n * 6.02).toFixed(2); q.ans = p/6.02; q.unit = "mol";
                q.txt = `${c.f} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${p}√ó10¬≤¬≥ ${txt_part} ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏µ‡πà‡πÇ‡∏°‡∏•? ${unitNote}`;
                q.sol1 = factorBox([{top:`${p}√ó10¬≤¬≥ ${u_part}`, bot:"1"}, {top:`1 mol ${c.f}`, bot:`6.02√ó10¬≤¬≥ ${u_part}`, res:`${q.ans.toFixed(2)} mol`}]);
                q.desc = `‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢ 6.02√ó10¬≤¬≥ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏°‡∏•`;
                q.sol2 = formulaBox(
                    `<b>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£:</b><br>N (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏∏‡∏†‡∏≤‡∏Ñ) = ${p}√ó10¬≤¬≥`, 
                    `n = N / (6.02√ó10¬≤¬≥) <br><small style='color:#cbd5e1'>(n = ‡πÇ‡∏°‡∏•)</small>`, 
                    `n = (${p}√ó10¬≤¬≥) / (6.02√ó10¬≤¬≥)`, 
                    `${q.ans.toFixed(2)} mol`
                );
                break;
            case 'mol_atom_count':
                q.ans = n * c.total; q.unit = "mol";
                q.txt = `${c.f} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${n} mol ‡∏°‡∏µ‡∏≠‡∏∞‡∏ï‡∏≠‡∏°‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏£‡∏ß‡∏°‡∏Å‡∏µ‡πà‡πÇ‡∏°‡∏•?`;
                q.sol1 = factorBox([{top:`${n} mol ${c.f}`, bot:"1"}, {top:`${c.total} mol atom`, bot:`1 mol ${c.f}`, res:`${q.ans.toFixed(2)} mol`}]);
                q.desc = `1 ‡πÇ‡∏°‡πÄ‡∏•‡∏Å‡∏∏‡∏•‡∏°‡∏µ ${c.total} ‡∏≠‡∏∞‡∏ï‡∏≠‡∏° (‡∏ô‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏¢‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô)`;
                q.sol2 = formulaBox(
                    `<b>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£:</b><br>n (‡πÇ‡∏°‡∏•‡∏™‡∏≤‡∏£) = ${n} mol<br>Sub (‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏¢‡∏£‡∏ß‡∏°) = ${c.total}`, 
                    `n(‡∏≠‡∏∞‡∏ï‡∏≠‡∏°) = n(‡∏™‡∏≤‡∏£) √ó ‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏¢‡∏£‡∏ß‡∏°`, 
                    `n(‡∏≠‡∏∞‡∏ï‡∏≠‡∏°) = ${n} √ó ${c.total}`, 
                    `${q.ans.toFixed(2)} mol`
                );
                break;
            case 'mol_elem_stoich':
                let elem = Object.keys(c.atom)[0]; let count = c.atom[elem];
                q.ans = n * count; q.unit = "mol";
                q.txt = `${c.f} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${n} mol ‡∏°‡∏µ‡∏ò‡∏≤‡∏ï‡∏∏ ${elem} ‡∏Å‡∏µ‡πà‡πÇ‡∏°‡∏•?`;
                q.sol1 = factorBox([{top:`${n} mol ${c.f}`, bot:"1"}, {top:`${count} mol ${elem}`, bot:`1 mol ${c.f}`, res:`${q.ans.toFixed(2)} mol`}]);
                q.desc = `‡∏î‡∏π‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏¢‡∏Ç‡∏≠‡∏á ${elem} ‡πÉ‡∏ô‡∏™‡∏π‡∏ï‡∏£ ‡∏Ñ‡∏∑‡∏≠ ${count}`;
                q.sol2 = formulaBox(
                    `<b>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£:</b><br>n (‡πÇ‡∏°‡∏•‡∏™‡∏≤‡∏£) = ${n} mol<br>Sub (‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏¢ ${elem}) = ${count}`, 
                    `n(${elem}) = n(‡∏™‡∏≤‡∏£) √ó ‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏¢`, 
                    `n(${elem}) = ${n} √ó ${count}`, 
                    `${q.ans.toFixed(2)} mol`
                );
                break;
            case 'mw_calc':
                let logic = []; let sum = 0;
                let awMap = {H:1, C:12, O:16, N:14, S:32, Na:23, Cl:35.5, Ca:40, K:39, Mn:55, Fe:56, He:4, Ne:20, Cu:63.5};
                let formulaStr = Object.entries(c.atom).map(([k,v]) => {
                    let w = awMap[k] || 1; logic.push(`(${v}√ó${w})`); sum += v*w; return `${k}=${w}`;
                }).join(', ');
                q.ans = sum; q.unit = "g/mol";
                q.txt = `‡∏à‡∏á‡∏´‡∏≤‡∏°‡∏ß‡∏•‡πÇ‡∏°‡πÄ‡∏•‡∏Å‡∏∏‡∏• (MW) ‡∏Ç‡∏≠‡∏á ${c.f} (‡∏Å‡∏≥‡∏´‡∏ô‡∏î ${formulaStr})`;
                q.sol1 = `<div style="text-align:center; font-size:1.1em;">${logic.join(' + ')}<br>= <b style="color:var(--primary)">${sum} g/mol</b></div>`;
                q.desc = `‡∏ô‡∏≥‡∏°‡∏ß‡∏•‡∏≠‡∏∞‡∏ï‡∏≠‡∏°‡∏Ñ‡∏π‡∏ì‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏ß‡∏Å‡∏Å‡∏±‡∏ô`;
                q.sol2 = `<div>‡∏ú‡∏•‡∏£‡∏ß‡∏°: (‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏¢ √ó ‡∏°‡∏ß‡∏•‡∏≠‡∏∞‡∏ï‡∏≠‡∏°)</div>`;
                break;
            case 'density_m_v':
                let m_d = (n * 10).toFixed(1); q.ans = m_d / c.d; q.unit = "cm¬≥";
                q.txt = `${c.f}${showMW} (d = ${c.d} g/cm¬≥) ‡∏°‡∏ß‡∏• ${m_d} g ‡∏°‡∏µ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏µ‡πà cm¬≥?`;
                q.sol1 = factorBox([{top:`${m_d} ${u_g} ${c.f}`, bot:"1"}, {top:`1 cm¬≥`, bot:`${c.d} ${u_g} ${c.f}`, res:`${q.ans.toFixed(2)} cm¬≥`}]);
                q.desc = `‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ü‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢`;
                q.sol2 = formulaBox(
                    `<b>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£:</b><br>m (‡∏°‡∏ß‡∏•) = ${m_d} g<br>d (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô) = ${c.d} g/cm¬≥`, 
                    `V = m / d <br><small style='color:#cbd5e1'>(V = ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£)</small>`, 
                    `V = ${m_d} / ${c.d}`, 
                    `${q.ans.toFixed(2)} cm¬≥`
                );
                break;
            case 'density_v_m':
                let v_d = (n * 5).toFixed(1); q.ans = v_d * c.d; q.unit = "g";
                q.txt = `${c.f}${showMW} (d = ${c.d} g/cm¬≥) ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ ${v_d} cm¬≥ ‡∏°‡∏µ‡∏°‡∏ß‡∏•‡∏Å‡∏µ‡πà‡∏Å‡∏£‡∏±‡∏°?`;
                q.sol1 = factorBox([{top:`${v_d} <span class="u-canc">cm¬≥</span>`, bot:"1"}, {top:`${c.d} g ${c.f}`, bot:`1 <span class="u-canc">cm¬≥</span>`, res:`${q.ans.toFixed(2)} g`}]);
                q.desc = `‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô cm¬≥ ‡πÄ‡∏õ‡πá‡∏ô g ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤ d`;
                q.sol2 = formulaBox(
                    `<b>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£:</b><br>V (‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£) = ${v_d} cm¬≥<br>d (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô) = ${c.d} g/cm¬≥`, 
                    `m = V √ó d <br><small style='color:#cbd5e1'>(m = ‡∏°‡∏ß‡∏•‡∏™‡∏≤‡∏£)</small>`, 
                    `m = ${v_d} √ó ${c.d}`, 
                    `${q.ans.toFixed(2)} g`
                );
                break;
            case 'challenge_g_dm3':
                let gMass = (n*c.mw).toFixed(1); q.ans = (gMass/c.mw)*22.4; q.unit = "dm¬≥";
                q.txt = `[BONUS] ${c.f}${showMW} ‡∏°‡∏ß‡∏• ${gMass} g ‡∏°‡∏µ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏µ‡πà dm¬≥ STP?`;
                q.sol1 = factorBox([{top:`${gMass} ${u_g} ${c.f}`, bot:"1"}, {top:`1 ${u_mol} ${c.f}`, bot:`${c.mw} ${u_g} ${c.f}`}, {top:`22.4 dm¬≥`, bot:`1 ${u_mol} ${c.f}`, res:`${q.ans.toFixed(2)} dm¬≥`}]);
                q.desc = `‡∏Ç‡∏±‡πâ‡∏ô 1: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô g ‡πÄ‡∏õ‡πá‡∏ô mol (‡∏´‡∏≤‡∏£ MW)<br>‡∏Ç‡∏±‡πâ‡∏ô 2: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô mol ‡πÄ‡∏õ‡πá‡∏ô dm¬≥ (‡∏Ñ‡∏π‡∏ì 22.4)`;
                q.sol2 = formulaBox(
                    `<b>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£:</b><br>m=${gMass} g, MW=${c.mw}, STP=22.4`, 
                    `Step 1: n = m/MW<br>Step 2: V = n √ó 22.4`, 
                    `n = ${gMass}/${c.mw} = ${n} mol<br>V = ${n} √ó 22.4`, 
                    `${q.ans.toFixed(2)} dm¬≥`
                );
                break;
            case 'challenge_part_g':
                let pt = (n * 6.02).toFixed(2); q.ans = (pt/6.02)*c.mw; q.unit = "g";
                q.txt = `[BONUS] ${c.f}${showMW} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${pt}√ó10¬≤¬≥ ${unit_part} ‡∏°‡∏µ‡∏°‡∏ß‡∏•‡∏Å‡∏µ‡πà‡∏Å‡∏£‡∏±‡∏°? ${unitNote}`;
                q.sol1 = factorBox([{top:`${pt}√ó10¬≤¬≥ ${u_part}`, bot:"1"}, {top:`1 ${u_mol} ${c.f}`, bot:`6.02√ó10¬≤¬≥ ${u_part}`}, {top:`${c.mw} g ${c.f}`, bot:`1 ${u_mol} ${c.f}`, res:`${q.ans.toFixed(2)} g`}]);
                q.desc = `‡∏Ç‡∏±‡πâ‡∏ô 1: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏ô‡∏∏‡∏†‡∏≤‡∏Ñ‡πÄ‡∏õ‡πá‡∏ô mol (‡∏´‡∏≤‡∏£ 6.02..)<br>‡∏Ç‡∏±‡πâ‡∏ô 2: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô mol ‡πÄ‡∏õ‡πá‡∏ô g (‡∏Ñ‡∏π‡∏ì MW)`;
                q.sol2 = formulaBox(
                    `<b>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£:</b><br>N=${pt}√ó10¬≤¬≥, MW=${c.mw}`, 
                    `Step 1: n = N/6.02√ó10¬≤¬≥<br>Step 2: m = n √ó MW`, 
                    `n = ${pt}/6.02 = ${n} mol<br>m = ${n} √ó ${c.mw}`, 
                    `${q.ans.toFixed(2)} g`
                );
                break;
             default: 
                q.ans = n; q.unit = "mol"; q.txt = "Error"; q.sol1="..."; q.sol2="...";
        }
        
        g.q = q;
        document.getElementById('q-topic').innerText = TopicNames[type] || type;
        document.getElementById('q-main').innerHTML = q.txt;
        
        document.getElementById('sol-content').innerHTML = `
            <div style="margin-bottom:15px;">
                <div style="background:var(--primary); color:white; padding:5px 10px; font-size:0.9em; font-weight:bold; border-radius:5px 5px 0 0;">
                    ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: Factor Label (‡∏ï‡∏±‡∏î‡∏´‡∏ô‡πà‡∏ß‡∏¢)
                </div>
                <div style="border:1px solid var(--primary); padding:15px 10px; border-radius:0 0 5px 5px; background:rgba(255,255,255,0.5);">
                    ${q.sol1}
                    <div style="margin-top:10px; font-size:0.9em; color:#475569; border-top:1px dashed #cbd5e1; padding-top:5px;">
                        üí° ${q.desc || ''}
                    </div>
                </div>
            </div>
            <div>
                <div style="background:var(--cyan); color:white; padding:5px 10px; font-size:0.9em; font-weight:bold; border-radius:5px 5px 0 0;">
                    ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 2: Formula (‡πÉ‡∏ä‡πâ‡∏™‡∏π‡∏ï‡∏£)
                </div>
                <div style="border:1px solid var(--cyan); padding:10px; border-radius:0 0 5px 5px; background:rgba(255,255,255,0.5);">
                    ${q.sol2}
                </div>
            </div>
        `;
        
        document.getElementById('ans-in').value = '';
        clearInterval(g.timer); g.tCur = g.tMax; updateTimeBar();
        g.timer = setInterval(()=>{ g.tCur--; updateTimeBar(); if(g.tCur<=0) checkAns(true); },1000);
    }

    function updateTimeBar() { document.getElementById('time-bar').style.width = (g.tCur/g.tMax)*100 + '%'; }
    document.getElementById('ans-form').addEventListener('submit', (e)=>{ e.preventDefault(); checkAns(); });

    function checkAns(timeout=false) {
        clearInterval(g.timer);
        let uVal = parseFloat(document.getElementById('ans-in').value);
        let isCor = !timeout && Math.abs(uVal - g.q.ans) <= (g.q.ans*0.05 + 0.1); 
        
        document.getElementById('tut-ans').innerText = `${g.q.ans.toFixed(2)} ${g.q.unit}`;
        
        if(isCor) {
            playSfx('atk');
            document.getElementById('app').classList.add('anim-correct');
            document.getElementById('hero-img').classList.add('anim-atk-hero');
            document.getElementById('enemy-img').classList.add('anim-shake');
            setTimeout(() => {
                document.getElementById('app').classList.remove('anim-correct');
                document.getElementById('hero-img').classList.remove('anim-atk-hero');
                document.getElementById('enemy-img').classList.remove('anim-shake');
            }, 500);

            let praise = PositivePhrases[Math.floor(Math.random() * PositivePhrases.length)];
            document.getElementById('res-title').innerHTML = `<span style='color:#10b981'>‚úÖ ${praise}</span>`;
            
            document.getElementById('res-reward').style.display = 'block';
            document.getElementById('res-reward').innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏µ‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÄ‡∏•‡∏¢!";
            document.getElementById('res-btn').innerText = "‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•";
            document.getElementById('res-btn').onclick = () => {
                showScreen('scr-chest');
                document.getElementById('chest-result').innerHTML = "";
                document.getElementById('chest-next-btn').style.display = 'none';
                document.querySelectorAll('.chest-item').forEach(e=>{ e.style.pointerEvents='auto'; e.style.opacity='1'; e.innerText='üì¶'; });
            };
        } else {
            playSfx('wrong');
            document.getElementById('app').classList.add('anim-shake-screen');
            document.getElementById('app').classList.add('anim-dmg');
            document.getElementById('enemy-img').classList.add('anim-atk-enemy');
            
            setTimeout(() => {
                document.getElementById('app').classList.remove('anim-shake-screen');
                document.getElementById('app').classList.remove('anim-dmg');
                document.getElementById('enemy-img').classList.remove('anim-atk-enemy');
            }, 500);

            g.hp = Math.max(0, g.hp - 10);
            updateHUD();
            document.getElementById('res-title').innerHTML = "<span style='color:#ef4444'>‚ùå ‡∏ú‡∏¥‡∏î‡∏à‡πâ‡∏≤ ‡∏™‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞!</span>";
            document.getElementById('res-reward').style.display = 'none';
            document.getElementById('res-btn').innerText = "‡πÑ‡∏õ‡∏ï‡πà‡∏≠";
            document.getElementById('res-btn').onclick = () => { 
                if(g.hp<=0) resetGame(); else { nextQuest(); showScreen('scr-game'); }
            };
        }
        showScreen('scr-result');
    }

    function selectChest(i) {
        document.querySelectorAll('.chest-item').forEach(e=>e.style.pointerEvents='none');
        document.querySelectorAll('.chest-item').forEach((e,idx)=>{ if(idx!==i-1) e.style.opacity='0.3'; });
        
        let rng = Math.random();
        let xp = g.isBonus ? 40 : 20;
        let msg = "", col = "";
        
        if(rng < 0.2) {
            // POISON (20%)
            g.isPoisoned = true; g.hp-=5; 
            msg="‚ò†Ô∏è ‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å‡∏û‡∏¥‡∏©! (‡πÇ‡∏î‡∏ô‡∏û‡∏¥‡∏©‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á)"; col="var(--poison)"; playSfx('wrong');
        } else if(rng < 0.3) {
            // CURSE (10%) - NEW
            g.hp = Math.max(0, g.hp-10);
            msg="üîÆ ‡∏Ñ‡∏≥‡∏™‡∏≤‡∏õ‡∏°‡∏£‡∏ì‡∏∞! (HP -10 ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)"; col="var(--curse)"; playSfx('wrong');
            document.getElementById('app').classList.add('anim-dmg');
            setTimeout(() => document.getElementById('app').classList.remove('anim-dmg'), 500);
        } else if(rng < 0.5) {
            // HEAL
            g.hp = Math.min(g.hp+30, g.maxHp); msg="üíñ ‡πÑ‡∏î‡πâ‡∏¢‡∏≤‡∏ü‡∏∑‡πâ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î (+30 HP)"; col="#ef4444"; playSfx('win');
        } else if(rng < 0.7) {
            // MANA
            g.mp = Math.min(g.mp+20, g.maxMp); msg="üíß ‡πÑ‡∏î‡πâ‡∏¢‡∏≤‡∏°‡∏≤‡∏ô‡∏≤ (+20 MP)"; col="var(--primary)"; playSfx('win');
        } else {
            // EXP
            g.xp += xp; msg=`‚ú® ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö EXP (+${xp})`; col="var(--gold)"; playSfx('win');
        }
        
        checkLevelUp(); updateHUD();
        document.getElementById('chest-result').innerHTML = `<span style="color:${col}">${msg}</span>`;
        document.getElementById('chest-next-btn').style.display = 'block';
    }
    
    function finishChest() {
        if(g.examScore >= g.targetScore) { playSfx('win'); showScreen('scr-win'); }
        else { nextQuest(); showScreen('scr-game'); }
    }

    function checkLevelUp() {
        if(g.xp >= g.maxXp) { g.xp-=g.maxXp; g.lv++; g.examScore++; g.maxXp+=5; g.hp=g.maxHp; playSfx('win'); }
    }

    function resetGame() { showScreen('scr-landing'); }
    function nextQuest() {
        // Poison Logic (-2 per turn)
        if(g.isPoisoned) { 
            g.hp = Math.max(0, g.hp - 2);
            document.getElementById('app').classList.add('anim-dmg');
            setTimeout(() => document.getElementById('app').classList.remove('anim-dmg'), 300);
            if(g.hp<=0) resetGame(); 
        }
        updateHUD(); genQuest();
    }
    
    function updateHUD() {
        document.getElementById('hp-bar').style.width = (g.hp/g.maxHp)*100 + '%';
        document.getElementById('mp-bar').style.width = (g.mp/g.maxMp)*100 + '%';
        document.getElementById('xp-bar').style.width = (g.xp/g.maxXp)*100 + '%';
        document.getElementById('lv-txt').innerText = "Lv."+g.lv;
        document.getElementById('score-txt').innerText = g.examScore + " ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô";
        document.getElementById('poison-mark').style.display = g.isPoisoned ? 'flex' : 'none';
    }

    // Calc Logic
    function toggleCalc() { 
        let c = document.getElementById('calc'); let game = document.getElementById('scr-game');
        if(c.style.display==='flex'){ 
            c.style.display='none'; game.classList.remove('calc-mode'); 
        } else { 
            c.style.display='flex'; game.classList.add('calc-mode'); 
            // Copy Current Question to Calc Display
            document.getElementById('calc-q-display').innerHTML = g.q.txt || "‡πÇ‡∏à‡∏ó‡∏¢‡πå...";
        }
    }
    function cIn(v){ document.getElementById('c-disp').value+=v; }
    function cClr(){ document.getElementById('c-disp').value=''; }
    function cDel(){ let d=document.getElementById('c-disp'); d.value=d.value.slice(0,-1); }
    function cEval(){ try{ let v=eval(document.getElementById('c-disp').value); document.getElementById('c-disp').value=parseFloat(v).toFixed(2); document.getElementById('ans-in').value=parseFloat(v).toFixed(2); }catch{document.getElementById('c-disp').value='Err';} }

    // Skills
    function useSkill(t) {
        if(t==='heal') {
            if(g.mp < 20) return alert('MP ‡πÑ‡∏°‡πà‡∏û‡∏≠ (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ 20)');
            g.mp-=20; g.hp=Math.min(g.hp+50,g.maxHp); g.isPoisoned=false; 
            updateHUD();
            document.getElementById('hero-img').classList.add('anim-shake');
            setTimeout(()=>document.getElementById('hero-img').classList.remove('anim-shake'), 400);
            playSfx('win');
        }
        else if(t==='time') {
            if(g.mp < 15) return alert('MP ‡πÑ‡∏°‡πà‡∏û‡∏≠ (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ 15)');
            g.mp-=15; g.tCur = Math.min(g.tCur+30, g.tMax); 
            updateHUD(); updateTimeBar();
            playSfx('win');
        }
        else if(t==='skip') {
            if(g.mp < 30) return alert('MP ‡πÑ‡∏°‡πà‡∏û‡∏≠ (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ 30)');
            g.mp-=30; nextQuest();
        }
        else if(t==='hint') { 
            if(g.mp < 10) return alert('MP ‡πÑ‡∏°‡πà‡∏û‡∏≠ (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ 10)');
            g.mp-=10; 
            // NEW SPECIFIC HINT LOGIC
            document.getElementById('q-hint-box').innerHTML = g.q.hintText; 
            document.getElementById('q-hint-box').style.display='block'; updateHUD(); 
        }
    }
</script>
</body>
</html>